[
    {
        "id": "90edd330fe6e2910",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "name": "解析回應(hmi)",
        "func": "/**\n * HMI 處理器 - 觸控螢幕指令解析\n */\n\nconst MIN_MIRED = 167, MAX_MIRED = 333;\n\nconst HMI_pattern = [\n    // ========== 空調控制 ==========\n    {\n        name: \"hvac_power_mode\",\n        pattern: [0x01, 0x31, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const powerValue = input[2];\n            const hvacId = input[5];\n            const mode = powerValue === 0x01 ? \"cool\" : \"off\";  // 開機預設冷氣模式\n            return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/mode/set`, payload: mode }];\n        }\n    },\n    {\n        name: \"hvac_temperature\",\n        pattern: [0x01, 0x32, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const tempValue = input[2];\n            const hvacId = input[5];\n            return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/temperature/set`, payload: String(tempValue) }];\n        }\n    },\n    {\n        name: \"hvac_mode\",\n        pattern: [0x01, 0x33, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const modeValue = input[2];\n            const hvacId = input[5];\n            const MODE_MAP = {\n                0x00: \"cool\",\n                0x01: \"dry\",\n                0x02: \"fan_only\",\n                0x04: \"heat\"\n            };\n            const mode = MODE_MAP[modeValue];\n            if (!mode) return null;\n            return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/mode/set`, payload: mode }];\n        }\n    },\n    {\n        name: \"hvac_fan_speed\",\n        pattern: [0x01, 0x34, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const fanValue = input[2];\n            const hvacId = input[5];\n            const FAN_MAP = {\n                0x03: \"medium\",\n                0x04: \"high\",\n                0x05: \"auto\",\n                0x07: \"low\"\n            };\n            const fan = FAN_MAP[fanValue];\n            if (!fan) return null;\n            return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/fan/set`, payload: fan }];\n        }\n    },\n];\n\nfunction matchPattern(input, pattern) {\n    if (input.length < pattern.length) return false;\n    for (let i = 0; i < pattern.length; i++) {\n        if (pattern[i] !== null && pattern[i] !== input[i]) {\n            return false;\n        }\n    }\n    return true;\n}\n\nfunction bufferToHexArray(buf) {\n    return [...buf].map(v => \"0x\" + v.toString(16).padStart(2, \"0\").toUpperCase());\n}\n\nif (!msg.payload || !Buffer.isBuffer(msg.payload)) {\n    return null;\n}\n\nlet input = Array.from(msg.payload);\nlet result = null;\n\nfor (const p of HMI_pattern) {\n    if (matchPattern(input, p.pattern)) {\n        result = p.parse(input);\n        if (result && Array.isArray(result) && result.length > 0) return [result];\n        break;\n    }\n}\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2720,
        "y": 1060,
        "wires": [
            [
                "4c17d151690d8caa"
            ]
        ]
    }
]