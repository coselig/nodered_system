[
    {
        "id": "8dc927f2ab7dee3c",
        "type": "tab",
        "label": "æ£®æ ¼v2",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "11f87a6bcf9619fe",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "flow set äº®åº¦è‰²æº«æš«å­˜",
        "style": {
            "label": true
        },
        "nodes": [
            "a987c2e5c6fc0ec7",
            "8c8ea648612f786b",
            "75e48fb32899196e",
            "1b5a8b9e2f92c7a7",
            "c644307a2a3512f4",
            "021ff1b024e9a7c2"
        ],
        "x": 794,
        "y": 19,
        "w": 712,
        "h": 202
    },
    {
        "id": "a7c8c0bb7568a462",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "è¨­å‚™è¼ªè©¢",
        "style": {
            "label": true
        },
        "nodes": [
            "71de6bd3492a1507",
            "ee321ede4da810ad",
            "db30960ba7f10786"
        ],
        "x": 34,
        "y": 319,
        "w": 532,
        "h": 82
    },
    {
        "id": "aad82665201d1fca",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "å–®è‰²æº«dimmer : homeassistant/light/single/+/+/set",
        "style": {
            "label": true
        },
        "nodes": [
            "dc6dd92d6511768f",
            "3977ff9f53058cdf"
        ],
        "x": 34,
        "y": 419,
        "w": 532,
        "h": 82
    },
    {
        "id": "70d3d7b5d81df148",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "i2å†·æ°£",
        "style": {
            "label": true
        },
        "nodes": [
            "dfd96a0c01302019",
            "71cf085f79164da4",
            "766c093269e65fd6",
            "01c3844fd1fb84e9",
            "c9a5e71c776ca1c2",
            "64da6e9f1ed67c9e",
            "63f4823f3a1765fa"
        ],
        "x": 34,
        "y": 959,
        "w": 832,
        "h": 162
    },
    {
        "id": "53feb12ccbb1440d",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "e1d1f5b38d4c0cf7",
            "83212497fcf06a53",
            "9d621a6d01361b6a",
            "8ba6364b4ee9d596",
            "212b51c9d193f9fc",
            "407680440b823891",
            "06b4a3425eb384d2",
            "759a596ab46d1c49",
            "e1e91405bf17866f",
            "5e73220d11206bde"
        ],
        "x": 54,
        "y": 1159,
        "w": 1152,
        "h": 142
    },
    {
        "id": "2d93e84dbc762f21",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "ä½‡åˆ—åŠŸèƒ½",
        "style": {
            "label": true
        },
        "nodes": [
            "4c05735b6a3c6c98",
            "97933ae9c90da632",
            "dce38c10e062cbf8",
            "39dfa3e6024e8e92",
            "3912bd7fe7e5e075",
            "12520c8349ebc8f6",
            "3dd6e3fdbafcc77b",
            "67988b0d6b89ac6b",
            "0544c0e13fe478be",
            "2cb5d87046cf4e48",
            "8bcf34a93310e225",
            "37db5abb5a3ef2b6",
            "81f07a968c7807da"
        ],
        "x": 1194,
        "y": 813,
        "w": 1172,
        "h": 348
    },
    {
        "id": "c960ad2cf785aa36",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "c0f38dc08e83a1d6",
            "34f55eeb9860cf13",
            "92fc9fbd75612075",
            "632a4f56cf5ffc8d",
            "8432f2ca0c84714e",
            "ea94445450788b19",
            "81aa1299bf091ca9",
            "b5db25ae410cb19f",
            "6fe5c78e99584d47",
            "089ec9eb9b2edeb3"
        ],
        "x": 54,
        "y": 1319,
        "w": 942,
        "h": 162
    },
    {
        "id": "33ade9d7c645295d",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "MQTT Discovery",
        "style": {
            "label": true
        },
        "nodes": [
            "7902852f67b90fa2",
            "e7e129d7a277fc85",
            "42add1442c66d8b2",
            "f675d457e3c7261c",
            "ee73d6b97e6530ba",
            "fd4ba7dc5129c2f4",
            "5074d6e5f20fb082",
            "aa8c8a0853aad52c",
            "b7765fda7251893c",
            "ce072fe56cde3451",
            "2df20c61c85aa9a3",
            "d7539ca3d8a66432"
        ],
        "x": 34,
        "y": 19,
        "w": 732,
        "h": 282
    },
    {
        "id": "b8c92d5cdb2f808b",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "8e3d5b85c16a60a5",
            "d90b15f5807aa3d1",
            "d71600625a7371ce",
            "40cb2d65fd51fbdd",
            "9b9c70d2d115f376",
            "f4325c7a165d56ac",
            "61ebd17b1aaf99f0",
            "bbd89b21b69295de"
        ],
        "x": 54,
        "y": 1519,
        "w": 792,
        "h": 142
    },
    {
        "id": "8150787aaa7b18c0",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "æ—¥ç«‹å†·æ°£",
        "style": {
            "label": true
        },
        "nodes": [
            "9b34d9d0506837d4",
            "2e127fee5de3e7e6",
            "2a28d9a5bf476a48",
            "d7731ab0b24d675f",
            "c2dd03142f5d4aa9",
            "47aaae1ecb8daf0e",
            "fcbfa886645c2380"
        ],
        "x": 34,
        "y": 779,
        "w": 742,
        "h": 162
    },
    {
        "id": "fbc54bd83cbfb9d0",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "å–®è‰²æº«dimmer : homeassistant/light/dual/+/+/set",
        "style": {
            "label": true
        },
        "nodes": [
            "b45c429b43b19195",
            "3a22374dff3a0d3a"
        ],
        "x": 34,
        "y": 519,
        "w": 532,
        "h": 82
    },
    {
        "id": "c0fc12864140dc9d",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "æ²ç°¾: homeassistant/cover/+/+/+/set",
        "style": {
            "label": true
        },
        "nodes": [
            "be8e8d5182735965",
            "c4d17b45221b33b3",
            "b4146696b965e6c8",
            "837248e227f3867d",
            "a72fd371fad4db7f"
        ],
        "x": 34,
        "y": 639,
        "w": 752,
        "h": 122
    },
    {
        "id": "1054b9ebf82dca49",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "name": "FeedBack",
        "style": {
            "label": true
        },
        "nodes": [
            "c4b381f3dfde98e3",
            "c5e858d45b07851e",
            "4a797ecbcebbf869",
            "d736ce249ca02c8b",
            "d823a94093e3ebaa",
            "aeb5d329737c210a",
            "90edd330fe6e2910",
            "4c17d151690d8caa",
            "8d4a6d0b00491221",
            "7c8300e57aa079a4"
        ],
        "x": 2394,
        "y": 899,
        "w": 772,
        "h": 202
    },
    {
        "id": "37db5abb5a3ef2b6",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "å†·æ°£ç¶²é—œ",
        "style": {
            "label": true,
            "stroke-opacity": "0"
        },
        "nodes": [
            "9008d6f89255fd25"
        ],
        "x": 1854,
        "y": 839,
        "w": 272,
        "h": 82
    },
    {
        "id": "81f07a968c7807da",
        "type": "group",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "éå†·æ°£é¡å‹çš„ç¶²é—œ",
        "style": {
            "stroke": "none",
            "stroke-opacity": "0.3",
            "label": true
        },
        "nodes": [
            "ba4394f96634d43c",
            "e03c4bafb2cdf6d4",
            "de75cc0c82bb599c",
            "5f6f957295b47d82"
        ],
        "x": 1854,
        "y": 899,
        "w": 332,
        "h": 122
    },
    {
        "id": "5940262c17b7a555",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "x": 1080,
        "y": 820,
        "wires": [
            [
                "67988b0d6b89ac6b"
            ]
        ]
    },
    {
        "id": "0544c0e13fe478be",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "x": 1620,
        "y": 980,
        "wires": [
            [
                "3dd6e3fdbafcc77b"
            ]
        ]
    },
    {
        "id": "06b4a3425eb384d2",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "x": 720,
        "y": 1220,
        "wires": [
            [
                "e1e91405bf17866f",
                "5e73220d11206bde"
            ]
        ]
    },
    {
        "id": "759a596ab46d1c49",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "x": 1080,
        "y": 1240,
        "wires": [
            [
                "407680440b823891"
            ]
        ]
    },
    {
        "id": "81aa1299bf091ca9",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "x": 540,
        "y": 1380,
        "wires": [
            [
                "6fe5c78e99584d47",
                "089ec9eb9b2edeb3"
            ]
        ]
    },
    {
        "id": "b5db25ae410cb19f",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "x": 880,
        "y": 1400,
        "wires": [
            [
                "92fc9fbd75612075"
            ]
        ]
    },
    {
        "id": "9b9c70d2d115f376",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "b8c92d5cdb2f808b",
        "x": 440,
        "y": 1600,
        "wires": [
            [
                "61ebd17b1aaf99f0",
                "bbd89b21b69295de"
            ]
        ]
    },
    {
        "id": "f4325c7a165d56ac",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "b8c92d5cdb2f808b",
        "x": 720,
        "y": 1600,
        "wires": [
            [
                "d71600625a7371ce"
            ]
        ]
    },
    {
        "id": "2cb5d87046cf4e48",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "x": 2220,
        "y": 920,
        "wires": [
            [
                "3912bd7fe7e5e075",
                "8d4a6d0b00491221",
                "dce38c10e062cbf8"
            ]
        ]
    },
    {
        "id": "8d4a6d0b00491221",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "x": 2440,
        "y": 1000,
        "wires": [
            [
                "c5e858d45b07851e",
                "d823a94093e3ebaa",
                "aeb5d329737c210a",
                "90edd330fe6e2910"
            ]
        ]
    },
    {
        "id": "4c17d151690d8caa",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "x": 2940,
        "y": 1020,
        "wires": [
            [
                "c4b381f3dfde98e3",
                "4a797ecbcebbf869"
            ]
        ]
    },
    {
        "id": "de75cc0c82bb599c",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "g": "81f07a968c7807da",
        "x": 1880,
        "y": 960,
        "wires": [
            [
                "ba4394f96634d43c",
                "e03c4bafb2cdf6d4"
            ]
        ]
    },
    {
        "id": "5f6f957295b47d82",
        "type": "junction",
        "z": "8dc927f2ab7dee3c",
        "g": "81f07a968c7807da",
        "x": 2160,
        "y": 960,
        "wires": [
            [
                "2cb5d87046cf4e48"
            ]
        ]
    },
    {
        "id": "7902852f67b90fa2",
        "type": "inject",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "åŠ å…¥ Discovery",
        "props": [
            {
                "p": "action",
                "v": "add",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 160,
        "y": 60,
        "wires": [
            [
                "aa8c8a0853aad52c"
            ]
        ]
    },
    {
        "id": "e7e129d7a277fc85",
        "type": "inject",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "æ¸…é™¤ Discovery",
        "props": [
            {
                "p": "action",
                "v": "clear",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 160,
        "y": 100,
        "wires": [
            [
                "aa8c8a0853aad52c"
            ]
        ]
    },
    {
        "id": "42add1442c66d8b2",
        "type": "mqtt out",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "ç™¼é€åˆ° MQTT Broker",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "751ec40a6956d4f9",
        "x": 640,
        "y": 80,
        "wires": []
    },
    {
        "id": "dc6dd92d6511768f",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "g": "aad82665201d1fca",
        "name": "",
        "topic": "homeassistant/light/single/+/+/set",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 190,
        "y": 460,
        "wires": [
            [
                "3977ff9f53058cdf"
            ]
        ]
    },
    {
        "id": "c4b381f3dfde98e3",
        "type": "mqtt out",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "name": "",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "751ec40a6956d4f9",
        "x": 3050,
        "y": 1000,
        "wires": []
    },
    {
        "id": "71de6bd3492a1507",
        "type": "inject",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "a7c8c0bb7568a462",
        "name": "",
        "props": [],
        "repeat": "3",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 130,
        "y": 360,
        "wires": [
            [
                "ee321ede4da810ad"
            ]
        ]
    },
    {
        "id": "ee321ede4da810ad",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "a7c8c0bb7568a462",
        "name": "è¨­å‚™æ¸…å–®",
        "func": "// è¨­å®šè¨­å‚™æ¸…å–®\nvar devices = context.get('devices') || [\n   11,12,13,\n    14,\n   15,16,17,18,19\n    ]; // é»˜èªè¨­å‚™æ¸…å–®\n// ç‚ºæ¯å€‹è¨­å‚™ç”Ÿæˆä¸€æ¢æ¶ˆæ¯\nvar msgs = devices.map(deviceID => {\n    return {\n        deviceID: deviceID // å°‡è¨­å‚™ ID æ·»åŠ åˆ°æ¶ˆæ¯ä¸­\n    };\n});\n\n// è¿”å›æ‰€æœ‰æ¶ˆæ¯\nreturn [msgs];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 360,
        "wires": [
            [
                "db30960ba7f10786"
            ]
        ]
    },
    {
        "id": "db30960ba7f10786",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "a7c8c0bb7568a462",
        "name": "è©¢å•åœ°å€(P404)",
        "func": "// ç²å–ç•¶å‰è¨­å‚™ ID\nvar deviceID = msg.deviceID;\n\n// è¨­å®šåƒæ•¸\nvar functionCode = 0x03;           // åŠŸèƒ½ç¢¼ï¼šè®€å–ä¿æŒæš«å­˜å™¨(Holding Register)\nvar startAddress = 2090;            // èµ·å§‹åœ°å€\nvar quantity = 4;                  // è®€å–æ•¸é‡\n\n// å°‡èµ·å§‹åœ°å€å’Œæ•¸é‡è½‰æ›ç‚ºå…©å€‹å­—ç¯€\nvar startAddressHigh = (startAddress >> 8) & 0xFF; // é«˜ä½\nvar startAddressLow = startAddress & 0xFF;        // ä½ä½\nvar quantityHigh = (quantity >> 8) & 0xFF;        // é«˜ä½\nvar quantityLow = quantity & 0xFF;               // ä½ä½\n\n// çµ„è£æŒ‡ä»¤\nvar message = [\n    deviceID,            // è¨­å‚™åœ°å€\n    functionCode,        // åŠŸèƒ½ç¢¼\n    startAddressHigh,    // èµ·å§‹åœ°å€é«˜ä½\n    startAddressLow,     // èµ·å§‹åœ°å€ä½ä½\n    quantityHigh,        // æ•¸é‡é«˜ä½\n    quantityLow          // æ•¸é‡ä½ä½\n];\n\n// è¨ˆç®— CRC æ ¡é©—\nvar crc = calculateCRC(message);\nmessage.push(crc[0]); // CRC ä½ä½\nmessage.push(crc[1]); // CRC é«˜ä½\n\n// å°‡æŒ‡ä»¤å­˜å…¥ msg.payload\nmsg.payload = Buffer.from(message);\nreturn msg;\n\n// CRC è¨ˆç®—å‡½å¼\nfunction calculateCRC(data) {\n    var crc = 0xFFFF;\n    for (var i = 0; i < data.length; i++) {\n        crc ^= data[i];\n        for (var j = 0; j < 8; j++) {\n            if ((crc & 0x0001) !== 0) {\n                crc >>= 1;\n                crc ^= 0xA001;\n            } else {\n                crc >>= 1;\n            }\n        }\n    }\n    return [crc & 0xFF, (crc >> 8) & 0xFF]; // è¿”å› CRC ä½ä½å’Œé«˜ä½\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 360,
        "wires": [
            [
                "5940262c17b7a555"
            ]
        ]
    },
    {
        "id": "a987c2e5c6fc0ec7",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "11f87a6bcf9619fe",
        "name": "æ›´æ–°å¿«å– (single brightness, MQTT)",
        "func": "/**\n * MQTT â†’ flow å¿«å–\n * topic: homeassistant/light/single/{id}/{channel}/set/brightness\n * payload: number (0â€“255)\n */\nconst topic = String(msg.topic || \"\");\nconst parts = topic.split(\"/\");\n\n// é©—è­‰ topic æ ¼å¼\nif (parts.length < 7 || parts[0] !== \"homeassistant\" || parts[1] !== \"light\" || parts[2] !== \"single\" || parts[5] !== \"set\" || parts[6] !== \"brightness\") {\n    return null; // æ ¼å¼ä¸ç¬¦ç›´æ¥å¿½ç•¥\n}\n\nconst id = parts[3];\nconst ch = parts[4];\nconst key = `single_${id}_${ch}_brightness`;\n\n// é©—è­‰ payload\nlet val = Number(msg.payload);\nif (!Number.isFinite(val)) return null;\nval = Math.max(0, Math.min(255, Math.round(val)));\n\n// æ›´æ–°å¿«å–\nflow.set(key, val);\nnode.status({ fill: \"green\", shape: \"dot\", text: `${key}=${val}` });\n\nreturn null; // åªæ›´æ–°å¿«å–ï¼Œä¸å¾€ä¸‹å‚³\n",
        "outputs": 0,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1340,
        "y": 60,
        "wires": []
    },
    {
        "id": "8c8ea648612f786b",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "g": "11f87a6bcf9619fe",
        "name": "",
        "topic": "homeassistant/light/single/+/+/set/brightness",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 990,
        "y": 60,
        "wires": [
            [
                "a987c2e5c6fc0ec7"
            ]
        ]
    },
    {
        "id": "4c05735b6a3c6c98",
        "type": "inject",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "æ‰‹å‹• Reset",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1300,
        "y": 880,
        "wires": [
            [
                "39dfa3e6024e8e92"
            ]
        ]
    },
    {
        "id": "97933ae9c90da632",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "æ”¶åˆ°å›æ‡‰ â†’ è§£é–",
        "func": "let t = flow.get(\"currentTimeout\");\nif (t) { clearTimeout(t); flow.set(\"currentTimeout\", null); }\n\nglobal.set(\"waitingReply\", false);\nflow.set(\"currentCmd\", null);\n\nreturn { payload: null }; // å–šé†’ã€Œç™¼é€æµç¨‹ + timeoutã€é€ä¸‹ä¸€ç­†\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2190,
        "y": 1120,
        "wires": [
            [
                "3dd6e3fdbafcc77b"
            ]
        ]
    },
    {
        "id": "dce38c10e062cbf8",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "éæ¿¾é›œè¨Š/æ®˜åŒ…",
        "func": "const buf = msg.payload;\nif (!Buffer.isBuffer(buf) || buf.length < 4) {  // ä¾å”è­°èª¿æ•´é–€æª»\n    return null; // ç•¥éï¼Œè®“ timeout æ©Ÿåˆ¶è™•ç†\n}\nreturn msg; // é€šéæ‰å»è§£é–\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2000,
        "y": 1120,
        "wires": [
            [
                "97933ae9c90da632"
            ]
        ]
    },
    {
        "id": "39dfa3e6024e8e92",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "é‡ç½®ä½‡åˆ—",
        "func": "// ä¸€éµæ¸…é™¤ + è§£é– + å–šé†’ï¼ˆå–®è¼¸å‡ºï¼‰\n// out[0] â†’ {payload:null} å–šé†’ã€Œç™¼é€æµç¨‹ + timeoutã€\n\n// 1) åœæ‰é€¾æ™‚è¨ˆæ™‚å™¨ï¼ˆé¿å…å¹½éˆå›å‘¼ï¼‰\nconst t = flow.get(\"currentTimeout\");\nif (t) { clearTimeout(t); }\n\n// 2) æ¸…é™¤åœ¨é€”ç‹€æ…‹\nflow.set(\"currentTimeout\", null);\nflow.set(\"currentCmd\", null);\nglobal.set(\"waitingReply\", false);\n\n// 3) æ¸…ç©ºä½‡åˆ—\nglobal.set(\"commandsQueue\", []);\n\n// 4) é¡¯ç¤ºç‹€æ…‹ï¼ˆæ–¹ä¾¿æª¢æŸ¥ï¼‰\nnode.status({\n  fill: \"green\",\n  shape: \"ring\",\n  text: \"å·²æ¸…é™¤, queue=0\"\n});\n\n// 5) å›å‚³ï¼šç›´æ¥å–šé†’ç™¼é€æµç¨‹\nreturn { payload: null };\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1440,
        "y": 880,
        "wires": [
            [
                "3dd6e3fdbafcc77b"
            ]
        ]
    },
    {
        "id": "3912bd7fe7e5e075",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "å›è¦†",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2270,
        "y": 860,
        "wires": []
    },
    {
        "id": "12520c8349ebc8f6",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "ç™¼é€",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1750,
        "y": 860,
        "wires": []
    },
    {
        "id": "3dd6e3fdbafcc77b",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "ç™¼é€æµç¨‹ + timeout",
        "func": "// === ç™¼é€æµç¨‹ + timeout ===\n// åŠŸèƒ½ï¼š\n// 1. å¾ commandsQueue å–å‡ºä¸‹ä¸€ç­†æŒ‡ä»¤ä¸¦ç™¼é€\n// 2. å•Ÿå‹• Timeout + Retry æ©Ÿåˆ¶\n// 3. è¶…é MAX_RETRY â†’ ä¸Ÿæ‰è©²ç­†ï¼Œç¹¼çºŒä¸‹ä¸€ç­†\n// 4. éƒ¨ç½²å¾Œè‡ªå‹•è§£é–ï¼ˆé¿å… waitingReply å¡æ­»ï¼‰\n\nconst TIMEOUT_MS = 200; // å»ºè­° 600~1200msï¼Œä¾è¨­å‚™å›è¦†æ™‚é–“èª¿æ•´\nconst MAX_RETRY = 2;   // æœ€å¤§é‡é€æ¬¡æ•¸ï¼›ç¸½ç™¼é€æ¬¡æ•¸ = 1 + MAX_RETRY\n\n// === Queue ç‹€æ…‹ ===\nlet queue = global.get(\"commandsQueue\");\nif (!Array.isArray(queue)) {\n  queue = [];\n  global.set(\"commandsQueue\", queue);\n}\n\nconst busy = !!global.get(\"waitingReply\");\n\n// === è‹¥å¿™ç¢Œæˆ–ä½‡åˆ—ç©º â†’ ä¸å‹•ä½œ ===\nif (busy || queue.length === 0) return [null, null];\n\n// === å– FIFO å‡ºåˆ— ===\nconst cmd = queue.shift();\nglobal.set(\"commandsQueue\", queue);\nglobal.set(\"waitingReply\", true);\n\n// æº–å‚™è¨Šæ¯ï¼ˆå« retry è¨ˆæ•¸ï¼‰\nlet outMsg = { payload: cmd, retry: 0 };\nflow.set(\"currentCmd\", outMsg);\n\n// === Timeout + Retry æ©Ÿåˆ¶ ===\nfunction armTimeout(cur) {\n  const timer = setTimeout(() => {\n    cur.retry += 1;\n\n    if (cur.retry <= MAX_RETRY) {\n      // Retry â†’ é‡é€åŒä¸€ç­†\n      flow.set(\"currentCmd\", cur);\n      node.send([cur, null]);  // å†é€ä¸€æ¬¡åˆ° TCP\n      armTimeout(cur);         // é‡æ–°æ› Timeout\n    } else {\n      // è¶…é MAX_RETRY â†’ ä¸Ÿæ£„é€™ç­†ï¼Œè§£é–ç¹¼çºŒä¸‹ä¸€ç­†\n      global.set(\"waitingReply\", false);\n      flow.set(\"currentCmd\", null);\n      flow.set(\"currentTimeout\", null);\n\n      node.status({\n        fill: \"red\",\n        shape: \"ring\",\n        text: \"æŒ‡ä»¤è¶…æ™‚å·²ä¸Ÿæ£„\"\n      });\n\n      // è§¸ç™¼ä¸‹ä¸€ç­†\n      node.send([null, { payload: { trigger: true, reason: \"timeout\" } }]);\n    }\n  }, TIMEOUT_MS);\n\n  flow.set(\"currentTimeout\", timer);\n}\n\n// === é€å‡ºç¬¬ä¸€ç­†ä¸¦æ› Timeout ===\narmTimeout(outMsg);\nreturn [outMsg, null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "// éƒ¨ç½²ç¯€é»å¾Œï¼Œæ­¤è™•æ·»åŠ çš„ä»£ç¢¼å°‡é‹è¡Œä¸€æ¬¡ã€‚ \n// éƒ¨ç½²åˆå§‹åŒ–ï¼šè‡ªå‹•æ¸…ç©º queue & è§£é–ï¼Œé¿å…éƒ¨ç½²å¾Œå¡æ­»\nglobal.set(\"commandsQueue\", []);\nglobal.set(\"waitingReply\", false);\nflow.set(\"currentCmd\", null);\nflow.set(\"currentTimeout\", null);\n\nnode.status({ fill: \"grey\", shape: \"ring\", text: \"éƒ¨ç½²å¾Œå·²é‡ç½®\" });",
        "finalize": "// ç¯€é»æ­£åœ¨åœæ­¢æˆ–é‡æ–°éƒ¨ç½²æ™‚ï¼Œå°‡é‹è¡Œæ­¤è™•æ·»åŠ çš„ä»£ç¢¼ã€‚ \n// åœæ­¢æˆ–é‡æ–°éƒ¨ç½²æ™‚æ¸…æ‰è¨ˆæ™‚å™¨\n\nconst t = flow.get(\"currentTimeout\");\nif (t) {\n    clearTimeout(t);\n}\nflow.set(\"currentTimeout\", null);\n\nglobal.set(\"commandsQueue\", []);\nglobal.set(\"waitingReply\", false);\nflow.set(\"currentCmd\", null);",
        "libs": [],
        "x": 1510,
        "y": 940,
        "wires": [
            [
                "12520c8349ebc8f6",
                "8bcf34a93310e225"
            ],
            [
                "0544c0e13fe478be"
            ]
        ],
        "info": "ã€åŠŸèƒ½èªªæ˜ã€‘\næ­¤ç¯€é»è² è²¬ï¼š\n1. å¾ commandsQueue ä½‡åˆ—ä¸­å–å‡ºä¸‹ä¸€ç­†æŒ‡ä»¤\n2. ç™¼é€è‡³ TCP ç¯€é»\n3. å•Ÿå‹• Retry æ©Ÿåˆ¶ï¼ˆé è¨­æœ€å¤šé‡é€ 2 æ¬¡ï¼‰\n4. è‹¥æˆåŠŸå›æ‡‰ â†’ ç”± handle_reply è§£é–ä½‡åˆ—\n5. è‹¥å¤±æ•—è¶…æ™‚ â†’ è‡ªå‹•è§£é–ä¸¦è§¸ç™¼ä¸‹ä¸€ç­†é€å‡º\n"
    },
    {
        "id": "67988b0d6b89ac6b",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "åŠ å…¥ä½‡åˆ—",
        "func": "// === åŠ å…¥ä½‡åˆ— ===\n// åŠŸèƒ½ï¼š\n// 1. æ¥æ”¶æŒ‡ä»¤ (msg.payload)\n// 2. æ¨å…¥ commandsQueue\n// 3. è‹¥ queue æ»¿ â†’ è‡ªå‹•æ¸…ç©º (Reset)\n// 4. è‹¥æœªå¿™ç¢Œ â†’ å–šé†’ç™¼é€æµç¨‹\n\nlet queue = global.get(\"commandsQueue\") || [];\nlet cmd = msg.payload;\n\n// ğŸ”¹ å¦‚æœæ˜¯ Arrayï¼Œè‡ªå‹•è½‰ Buffer\nif (Array.isArray(cmd)) {\n    cmd = Buffer.from(cmd);\n}\n\nconst MAX_QUEUE = 50;\n\n// === Queue æ»¿ â†’ è‡ªå‹• Reset ===\nif (queue.length >= MAX_QUEUE) {\n    // æ¸…ç©ºæ‰€æœ‰ç‹€æ…‹\n    global.set(\"commandsQueue\", []);\n    global.set(\"waitingReply\", false);\n    flow.set(\"currentCmd\", null);\n    flow.set(\"currentTimeout\", null);\n\n    node.status({\n        fill: \"red\",\n        shape: \"ring\",\n        text: \"âš ï¸ ä½‡åˆ—æ»¿ï¼Œè‡ªå‹•æ¸…ç©º\"\n    });\n\n    return { payload: null };  // å–šé†’ã€Œç™¼é€æµç¨‹ã€ï¼Œä½† queue å·²æ¸…ç©º\n}\n\n// === æ­£å¸¸æƒ…æ³ â†’ push é€²ä½‡åˆ— ===\nqueue.push(cmd);\nglobal.set(\"commandsQueue\", queue);\n\n// === ç‹€æ…‹é¡¯ç¤º ===\nnode.status({\n    fill: \"green\",\n    shape: \"dot\",\n    text: `ä½‡åˆ—é•·åº¦: ${queue.length}`\n});\n\n// === è‹¥ç›®å‰æ²’æœ‰åœ¨ç­‰å›è¦† â†’ è§¸ç™¼ç™¼é€æµç¨‹ ===\nlet waitingReply = global.get(\"waitingReply\") || false;\nif (!waitingReply) {\n    return { payload: null };   // âœ… å–šé†’ã€Œç™¼é€æµç¨‹ã€\n}\nreturn null;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1280,
        "y": 940,
        "wires": [
            [
                "3dd6e3fdbafcc77b"
            ]
        ]
    },
    {
        "id": "c5e858d45b07851e",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "name": "è§£æå›æ‡‰(P404)",
        "func": "// === Channel å°æ‡‰ byte æ˜ å°„ï¼ˆæ ¹æ“šé€šé“æ±ºå®šäº®åº¦èˆ‡è‰²æº«ä½å…ƒï¼‰===\nconst channelByteMap = {\n    // é›™è‰²æº«é€šé“ï¼ˆå«äº®åº¦èˆ‡è‰²æº«ï¼‰\n    \"a\": { type: \"dual\", brightnessByte: 4, colortempByte: 6 },\n    \"b\": { type: \"dual\", brightnessByte: 8, colortempByte: 10 },\n    // å–®è‰²æº«é€šé“ï¼ˆåªæœ‰äº®åº¦ï¼‰\n    \"1\": { type: \"single\", brightnessByte: 4 },\n    \"2\": { type: \"single\", brightnessByte: 6 },\n    \"3\": { type: \"single\", brightnessByte: 8 },\n    \"4\": { type: \"single\", brightnessByte: 10 },\n};\n\n// === ç‡ˆå…·é…ç½®æ¸…å–® ===\n// æ¯ç­†ç‡ˆå…·åŒ…å«åç¨±ã€Modbus IDã€é€šé“ç·¨è™Ÿï¼ˆchannelï¼‰\nconst lights = [\n    {id: 11, channel: \"1\" },\n    {id: 12, channel: \"1\" },\n    {id: 12, channel: \"2\" },\n    {id: 12, channel: \"3\" },\n    {id: 13, channel: \"1\" },\n    {id: 13, channel: \"2\" },\n    {id: 13, channel: \"3\" },\n    {id: 14, channel: \"a\" },\n    {id: 14, channel: \"b\" },\n    {id: 15, channel: \"1\" },\n    {id: 15, channel: \"2\" },\n    {id: 16, channel: \"1\" },\n    {id: 17, channel: \"1\" },\n    {id: 18, channel: \"1\" },\n    {id: 18, channel: \"2\" },\n    {id: 19, channel: \"1\" },\n    {id: 19, channel: \"2\" },\n];\n\n// === è‰²æº«è½‰æ›ï¼šModbus æ•¸å€¼ â†’ miredï¼ˆHA ä½¿ç”¨ï¼‰===\nfunction getColortempHA(modbusValue) {\n    const MIRED_MIN = 154;// 6500K\n    const MIRED_MAX = 370;// 2700K\n    return Math.round(MIRED_MAX + modbusValue / 100 * (MIRED_MIN - MIRED_MAX));\n}\n\n// === Modbus CRC é©—è­‰å‡½å¼ ===\nfunction verifyCRC(buf) {\n    let crc = 0xFFFF;\n    for (let i = 0; i < buf.length - 2; i++) {\n        crc ^= buf[i];\n        for (let j = 0; j < 8; j++) {\n            crc = (crc & 1) ? ((crc >> 1) ^ 0xA001) : (crc >> 1);\n        }\n    }\n    const crcLow = crc & 0xFF;\n    const crcHigh = (crc >> 8) & 0xFF;\n    return (crcLow === buf[buf.length - 2]) && (crcHigh === buf[buf.length - 1]);\n}\n\n// === ä¸»ç¨‹å¼é–‹å§‹ ===\nconst buffer = msg.payload;\n\n// === åŸºç¤é˜²éŒ¯æª¢æŸ¥ ===\nif (!Buffer.isBuffer(buffer)) return null;       // è³‡æ–™å¿…é ˆæ˜¯ Buffer\nif (buffer.length !== 13) return null;           // é•·åº¦éœ€ç‚º 13 bytesï¼ˆå›ºå®šæ ¼å¼ï¼‰\n\nconst id = buffer[0];                            // è£ç½® ID\nconst funcCode = buffer[1];                      // åŠŸèƒ½ç¢¼ï¼Œæ‡‰ç‚º 0x03\nconst byteCount = buffer[2];                     // è³‡æ–™é•·åº¦ï¼Œæ‡‰ç‚º 13\n\nif (funcCode !== 0x03 || byteCount !== 8) return null;\nif (!verifyCRC(buffer)) return null;             // CRC é©—è­‰å¤±æ•—å‰‡ä¸Ÿæ£„\n\n// === é–‹å§‹è§£ææ¯ç­†ç‡ˆå…· ===\nconst mqttMsgs = [];\n\nfor (const light of lights) {\n    if (light.id !== id) continue;  // åƒ…è™•ç†æ­¤å°åŒ…å°æ‡‰çš„ ID\n\n    const info = channelByteMap[light.channel];\n    if (!info) continue;  // channel ç„¡å°æ‡‰å®šç¾©å‰‡è·³é\n\n    const deviceID = light.id;\n    const channel = light.channel;\n    const type = info.type;\n    const brightness = buffer[info.brightnessByte];\n\n    // çµ„åˆ MQTT topic è·¯å¾‘\n    const stateTopic = `homeassistant/light/${type}/${deviceID}/${channel}`;\n    const setTopic = `${stateTopic}/set`;\n\n    // === é›™è‰²æº«ç‡ˆå…·è™•ç†é‚è¼¯ ===\n    if (type === \"dual\") {\n        // âœ… æ ¹æ“šäº®åº¦æ±ºå®š ON/OFF ç‹€æ…‹ï¼Œä¸¦æ±ºå®šæ˜¯å¦é€äº®åº¦æŒ‡ä»¤\n        if (brightness === 0) {\n            mqttMsgs.push({ topic: `${stateTopic}/state`, payload: \"OFF\" });\n        } else {\n            mqttMsgs.push(\n                { topic: `${stateTopic}/state`, payload: \"ON\" },\n                { topic: `${stateTopic}/brightness`, payload: brightness.toString() },\n                { topic: `${setTopic}/brightness`, payload: brightness.toString() }\n            );\n        }\n\n        // âœ… ç„¡è«–äº®åº¦ç‚ºä½•éƒ½é€ colortemp\n        const colortempModbus = buffer[info.colortempByte];\n        const colortempMired = getColortempHA(colortempModbus);\n\n        mqttMsgs.push(\n            { topic: `${stateTopic}/colortemp`, payload: colortempMired.toString() },\n            { topic: `${setTopic}/colortemp`, payload: colortempMired.toString() }\n        );\n    }\n\n    // === å–®è‰²æº«ç‡ˆå…·è™•ç†é‚è¼¯ ===\n    if (type === \"single\") {\n        if (brightness === 0) {\n            mqttMsgs.push({ topic: `${stateTopic}/state`, payload: \"OFF\" });\n        } else {\n            mqttMsgs.push(\n                { topic: `${stateTopic}/state`, payload: \"ON\" },\n                { topic: `${stateTopic}/brightness`, payload: brightness.toString() },\n                { topic: `${setTopic}/brightness`, payload: brightness.toString() }\n            );\n        }\n    }\n}\n\n// === è¼¸å‡ºæ‰€æœ‰çµ„åˆçš„ MQTT è¨Šæ¯é™£åˆ— ===\nreturn [mqttMsgs];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2720,
        "y": 980,
        "wires": [
            [
                "4c17d151690d8caa"
            ]
        ]
    },
    {
        "id": "75e48fb32899196e",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "g": "11f87a6bcf9619fe",
        "name": "",
        "topic": "homeassistant/light/dual/+/+/set/brightness",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 980,
        "y": 120,
        "wires": [
            [
                "c644307a2a3512f4"
            ]
        ]
    },
    {
        "id": "1b5a8b9e2f92c7a7",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "g": "11f87a6bcf9619fe",
        "name": "",
        "topic": "homeassistant/light/dual/+/+/set/colortemp",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 990,
        "y": 180,
        "wires": [
            [
                "021ff1b024e9a7c2"
            ]
        ]
    },
    {
        "id": "c644307a2a3512f4",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "11f87a6bcf9619fe",
        "name": "æ›´æ–°å¿«å– dual_brightness",
        "func": "/**\n * topic: homeassistant/light/dual/{id}/{channel}/set/brightness\n * payload: 0~255\n */\nconst parts = String(msg.topic||\"\").split(\"/\");\nif (parts.length<7 || parts[0]!=='homeassistant' || parts[1]!=='light' || parts[2]!=='dual' || parts[5]!=='set' || parts[6]!=='brightness') return null;\nconst id = parts[3];\nconst ch = (parts[4]||'').toLowerCase();\nlet val = Number(msg.payload);\nif (!Number.isFinite(val)) return null;\nval = Math.max(0, Math.min(255, Math.round(val)));\nconst key = `dual_${id}_${ch}_brightness`;\nflow.set(key, val);\nnode.status({fill:'green',shape:'dot',text:`${key}=${val}`});\nreturn null;",
        "outputs": 0,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1310,
        "y": 120,
        "wires": []
    },
    {
        "id": "021ff1b024e9a7c2",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "11f87a6bcf9619fe",
        "name": "æ›´æ–°å¿«å– dual_colortemp (mired)",
        "func": "/**\n * topic: homeassistant/light/dual/{id}/{channel}/set/colortemp\n * payload: mired å»ºè­° 154~370\n */\nconst parts = String(msg.topic||\"\").split(\"/\");\nif (parts.length<7 || parts[0]!=='homeassistant' || parts[1]!=='light' || parts[2]!=='dual' || parts[5]!=='set' || parts[6]!=='colortemp') return null;\nconst id = parts[3];\nconst ch = (parts[4]||'').toLowerCase();\nlet mired = Number(msg.payload);\nif (!Number.isFinite(mired)) return null;\n// å¤¾åœ¨å¸¸è¦‹ç¯„åœå…§ï¼Œé¿å…ç•°å¸¸å€¼\nmired = Math.max(154, Math.min(370, Math.round(mired)));\nconst key = `dual_${id}_${ch}_colortemp`;\nflow.set(key, mired);\nnode.status({fill:'blue',shape:'dot',text:`${key}=${mired}mired`});\nreturn null;",
        "outputs": 0,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1340,
        "y": 180,
        "wires": []
    },
    {
        "id": "f675d457e3c7261c",
        "type": "inject",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "åŠ å…¥ Discovery",
        "props": [
            {
                "p": "action",
                "v": "add",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 160,
        "y": 140,
        "wires": [
            [
                "fd4ba7dc5129c2f4"
            ]
        ]
    },
    {
        "id": "ee73d6b97e6530ba",
        "type": "inject",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "æ¸…é™¤ Discovery",
        "props": [
            {
                "p": "action",
                "v": "clear",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 160,
        "y": 180,
        "wires": [
            [
                "fd4ba7dc5129c2f4"
            ]
        ]
    },
    {
        "id": "fd4ba7dc5129c2f4",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "Discovery climate MQTT",
        "func": "// ç©ºèª¿è¨­å‚™é…ç½®ç”Ÿæˆå™¨\n// æ”¯æ´: HVAC ç©ºèª¿æ§åˆ¶\n\n// ============ ç©ºèª¿è¨­å‚™å®šç¾© ============\nlet devices = [\n    { path: \"hitachi/200/1\", name: \"å®¢å»³ç©ºèª¿\" },\n    { path: \"hitachi/200/2\", name: \"æœƒè­°å®¤ç©ºèª¿\" },\n    { path: \"hitachi/200/3\", name: \"ç„é—œç©ºèª¿\" },\n    { path: \"hitachi/200/9\", name: \"è¾¦å…¬å®¤æ¸¬è©¦\" },\n];\n\n// ============ è¨»å†Š/æ¸…é™¤é‚è¼¯ ============\nlet msgs = devices.map(dev => {\n    let uid = dev.path.replace(\"/\", \"_\");\n    let topic = `homeassistant/climate/${uid}/config`;\n    let payload;\n\n    if (msg.action === \"clear\") {\n        payload = \"\";\n    } else if (msg.action === \"add\") {\n        payload = {\n            name: dev.name,\n            unique_id: uid,\n            modes: [\"off\", \"cool\", \"heat\", \"dry\", \"fan_only\", \"auto\"],\n            mode_command_topic: `homeassistant/hvac/${dev.path}/mode/set`,\n            mode_state_topic: `homeassistant/hvac/${dev.path}/mode/state`,\n            temperature_command_topic: `homeassistant/hvac/${dev.path}/temperature/set`,\n            temperature_state_topic: `homeassistant/hvac/${dev.path}/temperature/state`,\n            min_temp: 16,\n            max_temp: 30,\n            temp_step: 1,\n            current_temperature_topic: `homeassistant/hvac/${dev.path}/current_temperature`,\n            fan_modes: [\"auto\", \"low\", \"medium\", \"high\"],\n            fan_mode_command_topic: `homeassistant/hvac/${dev.path}/fan/set`,\n            fan_mode_state_topic: `homeassistant/hvac/${dev.path}/fan/state`,\n            retain: false,\n            optimistic: true\n        };\n        payload = JSON.stringify(payload);\n    }\n\n    return { topic, payload, retain: false };\n});\n\nreturn [msgs];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 160,
        "wires": [
            [
                "5074d6e5f20fb082"
            ]
        ]
    },
    {
        "id": "5074d6e5f20fb082",
        "type": "mqtt out",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "ç™¼é€åˆ° MQTT Broker",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "751ec40a6956d4f9",
        "x": 640,
        "y": 160,
        "wires": []
    },
    {
        "id": "dfd96a0c01302019",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "70d3d7b5d81df148",
        "name": "",
        "topic": "homeassistant/hvac/i2/+/+/mode/set",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 240,
        "y": 1000,
        "wires": [
            [
                "c9a5e71c776ca1c2",
                "63f4823f3a1765fa"
            ]
        ]
    },
    {
        "id": "71cf085f79164da4",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "70d3d7b5d81df148",
        "name": "",
        "topic": "homeassistant/hvac/i2/+/+/temperature/set",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 220,
        "y": 1040,
        "wires": [
            [
                "c9a5e71c776ca1c2",
                "63f4823f3a1765fa"
            ]
        ]
    },
    {
        "id": "766c093269e65fd6",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "70d3d7b5d81df148",
        "name": "i2 command",
        "func": "const { id, port, device, key } = msg.payload;\n\n// èµ·å§‹æš«å­˜å™¨åœ°å€ï¼ˆä½ è¦å¯«å…¥çš„ä½ç½®ï¼‰\nconst startAddress = 0x01A5;     // å°æ‡‰ 42022\nconst registerCount = 2;         // å¯«å…¥å…©å€‹æš«å­˜å™¨\nconst byteCount = registerCount * 2;  // æ¯å€‹æš«å­˜å™¨ 2 bytes\n\n// å»ºç«‹è³‡æ–™å€ï¼ˆ2 å€‹æš«å­˜å™¨ï¼‰\nconst dataBytes = [\n    0x00, port,       // ç¬¬ 1 å€‹æš«å­˜å™¨ï¼šport = 1 â†’ 00 01\n    device, key       // ç¬¬ 2 å€‹æš«å­˜å™¨ï¼šdevice=2, key=3 â†’ 02 03\n];\n\n// çµ„åˆå®Œæ•´ frameï¼ˆä¸å« CRCï¼‰\nlet frame = [\n    id,\n    0x10,  // Function code: Write multiple registers\n    (startAddress >> 8) & 0xFF,\n    startAddress & 0xFF,\n    0x00, registerCount,\n    byteCount,\n    ...dataBytes\n];\n\n// è¨ˆç®— CRC16ï¼ˆMODBUSï¼‰\nfunction crc16Modbus(buf) {\n    let crc = 0xFFFF;\n    for (let b of buf) {\n        crc ^= b;\n        for (let i = 0; i < 8; i++) {\n            crc = (crc >> 1) ^ ((crc & 1) ? 0xA001 : 0);\n        }\n    }\n    return [crc & 0xFF, (crc >> 8) & 0xFF];\n}\n\nconst crc = crc16Modbus(frame);\nframe.push(...crc);\n\n// é™¤éŒ¯è¼¸å‡ºï¼ˆHEX å¯è®€ï¼‰\nmsg.debug = frame.map(b => b.toString(16).padStart(2, '0')).join(' ');\n\n// å¯¦éš›ç™¼é€ buffer\nmsg.payload = Buffer.from(frame);\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 1040,
        "wires": [
            [
                "5940262c17b7a555"
            ]
        ]
    },
    {
        "id": "01c3844fd1fb84e9",
        "type": "mqtt out",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "70d3d7b5d81df148",
        "name": "homeassistant/hvac/i2/+/+/mode/state",
        "topic": "",
        "qos": "1",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "751ec40a6956d4f9",
        "x": 715,
        "y": 1080,
        "wires": [],
        "l": false
    },
    {
        "id": "c9a5e71c776ca1c2",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "70d3d7b5d81df148",
        "name": "id, port, device, key",
        "func": "// topic æ ¼å¼ï¼šhomeassistant/hvac/i2/<id>/<port>/<type>/set\nconst [, , , id, port, type] = msg.topic.split('/');\nconst val = msg.payload.toString().toLowerCase();\n\nconst device = 0;\nconst defaultCoolTemp = 25;\n\nlet key;\nlet stateMsgs = [];\n\n// === Mode è¨­å®š ===\nif (type === \"mode\") {\n    if (val === \"cool\") {\n        key = 1;\n        stateMsgs.push(\n            { topic: `homeassistant/hvac/i2/${id}/${port}/mode/state`, payload: \"cool\", retain: true },\n            { topic: `homeassistant/hvac/i2/${id}/${port}/temperature/state`, payload: String(defaultCoolTemp), retain: true }\n        );\n    } else if (val === \"off\") {\n        key = 0;\n        stateMsgs.push(\n            { topic: `homeassistant/hvac/i2/${id}/${port}/mode/state`, payload: \"off\", retain: true }\n        );\n    }\n}\n\n// === Temperature è¨­å®š ===\nif (type === \"temperature\") {\n    const temp = parseInt(val);\n    key = temp;\n    stateMsgs.push(\n        { topic: `homeassistant/hvac/i2/${id}/${port}/temperature/state`, payload: String(temp), retain: true },\n        { topic: `homeassistant/hvac/i2/${id}/${port}/mode/state`, payload: \"cool\", retain: true }\n    );\n}\n\n// === Output #1: Modbus æŒ‡ä»¤ ===\nconst mainMsg = {\n    payload: { id: +id, port: +port, device, key }\n};\n\n// === è¼¸å‡º ===\n// Output[0] = Modbus æŒ‡ä»¤\n// Output[1] = å¤šç­† MQTT ç‹€æ…‹\nreturn [mainMsg, stateMsgs];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 1040,
        "wires": [
            [
                "766c093269e65fd6",
                "64da6e9f1ed67c9e"
            ],
            [
                "01c3844fd1fb84e9"
            ]
        ]
    },
    {
        "id": "64da6e9f1ed67c9e",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "70d3d7b5d81df148",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 715,
        "y": 1000,
        "wires": [],
        "l": false
    },
    {
        "id": "e1d1f5b38d4c0cf7",
        "type": "comment",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "name": "TV  ON/OFFï¼ˆé»é–‹å…§å®¹ï¼‰",
        "info": "192.168.1.221 TCP:100\n\né›»è¦–ç‰†é›»è¦–é–‹\n\\xAA\\x11\\xFE\\x01\\x01\\x11\n\né›»è¦–ç‰†é›»è¦–é—œ\n\\xAA\\x11\\xFE\\x01\\x00\\x10",
        "x": 190,
        "y": 1200,
        "wires": []
    },
    {
        "id": "83212497fcf06a53",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "name": "command (ON)",
        "func": "if (msg.payload !== \"ON\") return null;\n\n// è‡ªè¨‚è¦ç™¼é€çš„å®Œæ•´æŒ‡ä»¤\nconst command =[\n    0xAA, 0x11, 0xFE, 0x01, 0x01, 0x11  \n]\n\n\n// ç›´æ¥æ‰“åŒ…æˆ Buffer è¼¸å‡º\nmsg.payload = Buffer.from(command);\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1220,
        "wires": [
            [
                "212b51c9d193f9fc",
                "06b4a3425eb384d2"
            ]
        ]
    },
    {
        "id": "9d621a6d01361b6a",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "name": "command (OFF)",
        "func": "if (msg.payload !== \"OFF\") return null;\n\n// è‡ªè¨‚è¦ç™¼é€çš„å®Œæ•´æŒ‡ä»¤\nconst command = [\n    0xAA, 0x11, 0xFE, 0x01, 0x00, 0x10\n];\n\n// ç›´æ¥æ‰“åŒ…æˆ Buffer è¼¸å‡º\nmsg.payload = Buffer.from(command);\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1260,
        "wires": [
            [
                "212b51c9d193f9fc",
                "06b4a3425eb384d2"
            ]
        ]
    },
    {
        "id": "8ba6364b4ee9d596",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "name": "",
        "topic": "homeassistant/button/tv",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 190,
        "y": 1240,
        "wires": [
            [
                "83212497fcf06a53",
                "9d621a6d01361b6a"
            ]
        ]
    },
    {
        "id": "212b51c9d193f9fc",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "name": "è¼¸å‡º",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 635,
        "y": 1260,
        "wires": [],
        "l": false
    },
    {
        "id": "407680440b823891",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "name": "å›æ‡‰",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1145,
        "y": 1240,
        "wires": [],
        "l": false
    },
    {
        "id": "c0f38dc08e83a1d6",
        "type": "comment",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "name": "æ“´å¤§æ©Ÿæ§åˆ¶ï¼ˆé»é–‹å…§å®¹ï¼‰",
        "info": "ğŸ“˜ æ§åˆ¶æŒ‡ä»¤åˆ—è¡¨ï¼ˆå®Œæ•´æ•´ç†ç‰ˆï¼‰\n\nã€åŸºæœ¬æŒ‡ä»¤ã€‘\nHELP / H / ?\nï¼ é¡¯ç¤ºå…¨éƒ¨æ§åˆ¶æŒ‡ä»¤ã€‚\n\nã€é›»æºæ§åˆ¶ã€‘\nPWR S/0/1\nSï¼é¡¯ç¤ºç‹€æ…‹\n0ï¼é—œé–‰\n1ï¼é–‹å•Ÿ\n\nã€è¼¸å…¥ä¾†æºé¸æ“‡ã€‘\nSOURCE S/0~5\nSï¼é¡¯ç¤ºç‹€æ…‹\n0ï¼HDMI 1\n1ï¼HDMI 2\n2ï¼å…‰çº–ï¼ˆOpticalï¼‰\n3ï¼åŒè»¸ï¼ˆCoaxialï¼‰\n4ï¼LINE IN\n5ï¼RCA IN\n\nã€éŸ³é‡æ§åˆ¶ã€‘\nVOL S/0~-80\nSï¼é¡¯ç¤ºéŸ³é‡\n+ ï¼ +0.5 dB\n++ ï¼ +2 dB\n- ï¼ -0.5 dB\n-- ï¼ -2 dB\nä¹Ÿå¯è¼¸å…¥ 0 ~ -80 dB\n\nMUTE S/0/1\nSï¼é¡¯ç¤ºç‹€æ…‹\n0ï¼å–æ¶ˆéœéŸ³\n1ï¼éœéŸ³\n\nã€éº¥å…‹é¢¨æ§åˆ¶ã€‘\nMICVOL S/0~30\nSï¼é¡¯ç¤ºéŸ³é‡\n+ ï¼ +0.5 dB\n- ï¼ -0.5 dB\nä¹Ÿå¯è¼¸å…¥ 0 ~ 30\n\nMICMODE S/0~3\nSï¼é¡¯ç¤ºç‹€æ…‹\n0ï¼é—œé–‰\n1ï¼æ™®é€šæ¨¡å¼\n2ï¼Phantom æ¨¡å¼\n3ï¼Line æ¨¡å¼\n\nã€ç³»çµ±æ“ä½œã€‘\nFADEFAULT ï¼ æ¢å¾©å‡ºå» é è¨­\nREBOOT ï¼ é‡å•Ÿ\n\nã€ç¶²è·¯è³‡è¨Šã€‘\nIPCONFIG ï¼ é¡¯ç¤º IP\nRESETIP ï¼ æ¢å¾©å‡ºå»  IP\nSHOWMAC ï¼ é¡¯ç¤º MAC\nSHOWTPORT ï¼ é¡¯ç¤º Telnet Port\nSHOWHPORT ï¼ é¡¯ç¤º HTTP Port\n\nã€ç¶²è·¯è¨­å®šã€‘\nSIPADD ï¼ è¨­å®š IP\nSNETMASK ï¼ è¨­å®šç¶²è·¯é®ç½©\nSGATEWAY ï¼ è¨­å®šé–˜é“\nSHTTPPORT ï¼ è¨­å®š HTTP Portï¼ˆ1~62235ï¼Œé è¨­ 80ï¼‰\nSTELNETPPORT ï¼ è¨­å®š Telnet Portï¼ˆ1~62235ï¼Œé è¨­ 23ï¼‰\n",
        "x": 190,
        "y": 1360,
        "wires": []
    },
    {
        "id": "34f55eeb9860cf13",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "name": "",
        "topic": "homeassistant/button/amp",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 190,
        "y": 1400,
        "wires": [
            [
                "8432f2ca0c84714e"
            ]
        ]
    },
    {
        "id": "92fc9fbd75612075",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "name": "å›æ‡‰",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 935,
        "y": 1400,
        "wires": [],
        "l": false
    },
    {
        "id": "632a4f56cf5ffc8d",
        "type": "inject",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "name": "æ‰‹å‹•æ¸¬è©¦",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "VOL +\\r",
        "payloadType": "str",
        "x": 400,
        "y": 1440,
        "wires": [
            [
                "81aa1299bf091ca9"
            ]
        ]
    },
    {
        "id": "8e3d5b85c16a60a5",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "b8c92d5cdb2f808b",
        "name": "",
        "topic": "cdps/command",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 160,
        "y": 1600,
        "wires": [
            [
                "40cb2d65fd51fbdd"
            ]
        ]
    },
    {
        "id": "d90b15f5807aa3d1",
        "type": "comment",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "b8c92d5cdb2f808b",
        "name": "ï¼´ï¼¶ç‰†æ§åˆ¶ï¼ˆé»é–‹å…§å®¹ï¼‰",
        "info": "20251119\nCDPS-CS11\nIPï¼š192.168.1.224\næ§åˆ¶åŸ ï¼šTCP 23\næŒ‡ä»¤çµå°¾\\x0d\\x0a\n\n\nset out A route 1~4\nè¨Šæº1~4åˆ‡æ›\n\nset power ON/OFF\né›»æºé–‹é—œ",
        "x": 190,
        "y": 1560,
        "wires": []
    },
    {
        "id": "d71600625a7371ce",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "b8c92d5cdb2f808b",
        "name": "å›æ‡‰",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 785,
        "y": 1600,
        "wires": [],
        "l": false
    },
    {
        "id": "3977ff9f53058cdf",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "aad82665201d1fca",
        "name": "command(single)new",
        "func": "/**\n * å–®è‰²æº«ï¼ˆsingleï¼‰æ§åˆ¶ï¼šç”¢ç”Ÿ Modbus æŒ‡ä»¤ï¼ˆå« CRC16ï¼‰\n * æ”¯æ´ payload = { \"state\": \"ON\" | \"OFF\", \"brightness\": number }\n */\n\nconst DEFAULT_BRIGHTNESS = 100;\nconst BRIGHTNESS_TIME = 0x05;\n\nconst CHANNEL_REGISTER_MAP = {\n    \"1\": 0x082A,\n    \"2\": 0x082B,\n    \"3\": 0x082C,\n    \"4\": 0x082D\n};\n\n/* ------------------------ CRC-16 MODBUS ------------------------ */\nfunction crc16(buf) {\n    let crc = 0xFFFF;\n    for (const b of buf) {\n        crc ^= b;\n        for (let i = 0; i < 8; i++) {\n            crc = (crc & 1)\n                ? ((crc >> 1) ^ 0xA001)\n                : (crc >> 1);\n        }\n    }\n    return crc;\n}\n\n/* ========================== ä¸»æµç¨‹ =========================== */\nconst topic = String(msg.topic || \"\");\nconst parts = topic.split(\"/\");\n\nif (parts.length !== 6) return null;\nif (parts[0] !== \"homeassistant\") return null;\nif (parts[1] !== \"light\") return null;\nif (parts[2] !== \"single\") return null;\nif (parts[5] !== \"set\") return null;\n\nconst slaveId = Number(parts[3]);\nconst channel = parts[4];\n\nif (!Number.isInteger(slaveId) || slaveId <= 0) return null;\nconst reg = CHANNEL_REGISTER_MAP[channel];\nif (!reg) return null;\n\n/* ------------------------ è§£æ payload ------------------------ */\nlet isOn = false;\nlet brightnessFromPayload = null;\n\nif (typeof msg.payload === \"object\" && msg.payload !== null) {\n    // JSON æ ¼å¼ {\"state\":\"ON\",\"brightness\":112}\n    if (typeof msg.payload.state === \"string\") {\n        isOn = (msg.payload.state.toUpperCase() === \"ON\");\n    }\n    if (typeof msg.payload.brightness === \"number\") {\n        brightnessFromPayload = msg.payload.brightness;\n    }\n} else if (typeof msg.payload === \"string\") {\n    isOn = (msg.payload.toUpperCase() === \"ON\");\n} else if (typeof msg.payload === \"boolean\") {\n    isOn = msg.payload;\n}\n\n/* ------------------------ äº®åº¦è™•ç† ------------------------ */\nconst brightnessKey = `single_${slaveId}_${channel}_brightness`;\nlet useBrightness = null;\n\n// payload æœ‰ brightness â†’ ç”¨ payload åŒæ™‚æ›´æ–°å¿«å–\nif (typeof brightnessFromPayload === \"number\") {\n    useBrightness = Math.round(brightnessFromPayload);\n    flow.set(brightnessKey, useBrightness);\n\n    // å¦å‰‡ç”¨å¿«å–\n} else {\n    useBrightness = flow.get(brightnessKey);\n    if (typeof useBrightness !== \"number\") {\n        useBrightness = DEFAULT_BRIGHTNESS;\n    }\n}\n\n// ç¯„åœä¿è­· 0~100\nuseBrightness = Math.min(100, Math.max(0, useBrightness));\n\n// OFF = 0ã€ON = äº®åº¦\nconst value = isOn ? useBrightness : 0x00;\n\n/* ------------------------ çµ„ Modbus æŒ‡ä»¤ ------------------------ */\nconst hi = (reg >> 8) & 0xFF;\nconst lo = reg & 0xFF;\n\nconst cmd = Buffer.from([\n    slaveId,\n    0x06,\n    hi,\n    lo,\n    BRIGHTNESS_TIME,\n    value\n]);\n\n/* ------------------------ åŠ  CRC ------------------------ */\nconst crc = crc16(cmd);\nconst crcLow = crc & 0xFF;\nconst crcHigh = (crc >> 8) & 0xFF;\n\nmsg.payload = Buffer.concat([\n    cmd,\n    Buffer.from([crcLow, crcHigh])\n]);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 460,
        "wires": [
            [
                "5940262c17b7a555"
            ]
        ]
    },
    {
        "id": "4a797ecbcebbf869",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "name": "debug 1",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 3060,
        "y": 1040,
        "wires": []
    },
    {
        "id": "aa8c8a0853aad52c",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "Discovery lights MQTT",
        "func": "/**\n * å‘½åè¦å‰‡ï¼š\n * relay_id_channel  â†’ ä¾‹å¦‚ relay_11_1\n * single_id_channel â†’ ä¾‹å¦‚ single_11_2\n * dual_id_channel   â†’ ä¾‹å¦‚ dual_12_aã€dual_12_b\n */\n\nlet devices = [\n    // ç›¤A\n    { path: \"single/11/1\", name: \"èµ°å»Šé–“ç…§\" },\n    { path: \"single/12/1\", name: \"æ³¡èŒ¶å€\" },\n    { path: \"single/12/2\", name: \"èµ°é“å´ç‡ˆ/åœ°é–“ç…§\" },\n    { path: \"single/12/3\", name: \"å±•ç¤ºæ«ƒ\" },\n    { path: \"single/13/1\", name: \"æœƒè­°é–“ç…§\" },\n    { path: \"single/13/2\", name: \"å†·æ°£é–“ç…§\" },\n    { path: \"single/13/3\", name: \"æœƒè­°å´ç‡ˆ\" },\n    { path: \"dual/14/a\", name: \"è»Œé“ç‡ˆ\" },\n    { path: \"dual/14/b\", name: \"åŠç‡ˆ\" },\n    // ç›¤B\n    { path: \"single/15/1\", name: \"å®¢å»³å‰\" },\n    { path: \"single/15/2\", name: \"å®¢å»³å¾Œ\" },\n    { path: \"single/16/1\", name: \"èµ°é“é–“ç…§\" },\n    { path: \"single/17/1\", name: \"å»šæˆ¿\" },\n    { path: \"single/18/1\", name: \"1Fåœ°ç‡ˆ\" },\n    { path: \"single/18/2\", name: \"1Få£ç‡ˆ\" },\n    { path: \"single/19/1\", name: \"2Få£ç‡ˆ\" },\n    { path: \"single/19/2\", name: \"2Fåœ°ç‡ˆ\" },\n];\n\nlet msgs;\n\nif (msg.action === \"clear\") {\n    // å¼·åˆ¶å…¨éƒ¨æ¸…é™¤\n    msgs = devices.map(dev => {\n        let uid = dev.path.replaceAll(\"/\", \"_\");\n        return {\n            topic: `homeassistant/light/${uid}/config`,\n            payload: \"\",\n            retain: false,\n        };\n    });\n} else if (msg.action === \"add\") {\n    // åŸæœ¬ add çš„æµç¨‹\n    msgs = devices.map(dev => {\n        let uid = dev.path.replaceAll(\"/\", \"_\");\n        let topic = `homeassistant/light/${uid}/config`;\n        let basePayload = {\n            name: dev.name,\n            unique_id: uid,\n            object_id: uid,\n            payload_on: \"ON\",\n            payload_off: \"OFF\",\n            optimistic: true,\n            state_topic: `homeassistant/light/${dev.path}/state`,\n            command_topic: `homeassistant/light/${dev.path}/set`\n        };\n\n        if (dev.path.startsWith(\"single/\")) {\n            basePayload.brightness = true;\n            basePayload.brightness_state_topic = `homeassistant/light/${dev.path}/brightness`;\n            basePayload.brightness_command_topic = `homeassistant/light/${dev.path}/set/brightness`;\n            basePayload.brightness_scale = 100;\n        } else if (dev.path.startsWith(\"dual/\")) {\n            basePayload.brightness = true;\n            basePayload.brightness_state_topic = `homeassistant/light/${dev.path}/brightness`;\n            basePayload.brightness_command_topic = `homeassistant/light/${dev.path}/set/brightness`;\n            basePayload.brightness_scale = 100;\n            basePayload.color_temp_state_topic = `homeassistant/light/${dev.path}/colortemp`;\n            basePayload.color_temp_command_topic = `homeassistant/light/${dev.path}/set/colortemp`;\n            basePayload.min_mireds = 154;  // 6500K\n            basePayload.max_mireds = 370;  // 2700K\n        }\n\n        return {\n            topic,\n            payload: JSON.stringify(basePayload),\n            retain: false\n        };\n    });\n}\n\nreturn [msgs];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 80,
        "wires": [
            [
                "42add1442c66d8b2"
            ]
        ]
    },
    {
        "id": "63f4823f3a1765fa",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "70d3d7b5d81df148",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 540,
        "y": 1000,
        "wires": []
    },
    {
        "id": "8432f2ca0c84714e",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "name": "command",
        "func": "msg.payload = `${msg.payload}\\r\\n`;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 1400,
        "wires": [
            [
                "ea94445450788b19",
                "81aa1299bf091ca9"
            ]
        ]
    },
    {
        "id": "ea94445450788b19",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 400,
        "y": 1360,
        "wires": []
    },
    {
        "id": "40cb2d65fd51fbdd",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "b8c92d5cdb2f808b",
        "name": "command",
        "func": "msg.payload = `${msg.payload}\\r\\n`;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 1600,
        "wires": [
            [
                "9b9c70d2d115f376"
            ]
        ]
    },
    {
        "id": "b7765fda7251893c",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "discovery cover MQTT",
        "func": "// çª—ç°¾/æ²ç°¾è¨­å‚™é…ç½®ç”Ÿæˆå™¨\n// æ”¯æ´: çª—ç°¾(curtain), æ²ç°¾, æ’ç…™çª—\n\n// ============ çª—ç°¾è¨­å‚™å®šç¾© ============\nlet covers = [\n    { path: \"curtain/21/1-2-3\", name: \"éµæ²é–€\" },\n    { path: \"curtain/22/1-2\", name: \"æœƒè­°å®¤æ²ç°¾\" },\n    { path: \"curtain/23/1-2\", name: \"å¸ƒç°¾\" },\n    { path: \"curtain/23/3-4\", name: \"æ²™ç°¾\" },\n    { path: \"curtain/23/5-6-7\", name: \"æ’ç…™çª—\" },\n];\n\n\n// ============ è¨»å†Š/æ¸…é™¤é‚è¼¯ ============\nlet msgs;\n\nif (msg.action === \"clear\") {\n    // å¼·åˆ¶å…¨éƒ¨æ¸…é™¤\n    msgs = covers.map(cover => {\n        let uid = cover.path.replace(/\\//g, \"_\");\n        return {\n            topic: `homeassistant/cover/${uid}/config`,\n            payload: \"\",\n            retain: false\n        };\n    });\n} else if (msg.action === \"add\") {\n    // æ–°å¢è¨»å†Š\n    msgs = covers.map(cover => {\n        let uid = cover.path.replace(/\\//g, \"_\");\n        let part = cover.path.split(\"/\");\n        let device_type = part[0];\n        let id = part[1];\n        let control = (part[2]).split(\"-\");\n\n        let basePayload = {\n            name: cover.name,\n            unique_id: uid,\n            optimistic: true,\n            retain: false\n        };\n\n        let operation_type;\n        switch (control.length) {\n            case 2: {\n                operation_type = \"oc\";\n                basePayload.payload_open = `${control[0]}/${control[1]}`;\n                basePayload.payload_close = `${control[1]}/${control[0]}`;\n                basePayload.payload_stop = `${control[0]}_${control[1]}/`;\n                break;\n            }\n            case 3: {\n                operation_type = \"ocs\";\n                basePayload.payload_open = `${control[0]}/${control[1]}_${control[2]}`;\n                basePayload.payload_close = `${control[1]}/${control[0]}_${control[2]}`;\n                basePayload.payload_stop = `${control[2]}/${control[0]}_${control[1]}`;\n                break;\n            }\n            default: {\n                node.warn(\"Unknown type of curtain\");\n                break;\n            }\n        }\n\n        basePayload.command_topic = `homeassistant/cover/${device_type}/${id}/${operation_type}/set`;\n        basePayload.state_topic = `homeassistant/cover/${device_type}/${id}/${operation_type}/state`;\n\n        return {\n            topic: `homeassistant/cover/${uid}/config`,\n            payload: JSON.stringify(basePayload),\n        };\n    });\n}\n\nreturn [msgs];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 240,
        "wires": [
            [
                "ce072fe56cde3451"
            ]
        ]
    },
    {
        "id": "ce072fe56cde3451",
        "type": "mqtt out",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "ç™¼é€åˆ° MQTT Broker",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "751ec40a6956d4f9",
        "x": 640,
        "y": 240,
        "wires": []
    },
    {
        "id": "2df20c61c85aa9a3",
        "type": "inject",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "åŠ å…¥ Discovery",
        "props": [
            {
                "p": "action",
                "v": "add",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 160,
        "y": 220,
        "wires": [
            [
                "b7765fda7251893c"
            ]
        ]
    },
    {
        "id": "d7539ca3d8a66432",
        "type": "inject",
        "z": "8dc927f2ab7dee3c",
        "g": "33ade9d7c645295d",
        "name": "æ¸…é™¤ Discovery",
        "props": [
            {
                "p": "action",
                "v": "clear",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 160,
        "y": 260,
        "wires": [
            [
                "b7765fda7251893c"
            ]
        ]
    },
    {
        "id": "e1e91405bf17866f",
        "type": "tcp request",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "name": "",
        "server": "192.168.1.208",
        "port": "502",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 920,
        "y": 1220,
        "wires": [
            [
                "759a596ab46d1c49"
            ]
        ]
    },
    {
        "id": "5e73220d11206bde",
        "type": "tcp request",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "53feb12ccbb1440d",
        "name": "",
        "server": "192.168.1.204",
        "port": "502",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 920,
        "y": 1260,
        "wires": [
            [
                "759a596ab46d1c49"
            ]
        ]
    },
    {
        "id": "6fe5c78e99584d47",
        "type": "tcp request",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "name": "",
        "server": "192.168.1.208",
        "port": "502",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 740,
        "y": 1380,
        "wires": [
            [
                "b5db25ae410cb19f"
            ]
        ]
    },
    {
        "id": "089ec9eb9b2edeb3",
        "type": "tcp request",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "c960ad2cf785aa36",
        "name": "",
        "server": "192.168.1.204",
        "port": "502",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 740,
        "y": 1420,
        "wires": [
            [
                "b5db25ae410cb19f"
            ]
        ]
    },
    {
        "id": "61ebd17b1aaf99f0",
        "type": "tcp request",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "b8c92d5cdb2f808b",
        "name": "",
        "server": "192.168.1.208",
        "port": "502",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 580,
        "y": 1580,
        "wires": [
            [
                "f4325c7a165d56ac"
            ]
        ]
    },
    {
        "id": "bbd89b21b69295de",
        "type": "tcp request",
        "z": "8dc927f2ab7dee3c",
        "d": true,
        "g": "b8c92d5cdb2f808b",
        "name": "",
        "server": "192.168.1.204",
        "port": "502",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 580,
        "y": 1620,
        "wires": [
            [
                "f4325c7a165d56ac"
            ]
        ]
    },
    {
        "id": "ba4394f96634d43c",
        "type": "tcp request",
        "z": "8dc927f2ab7dee3c",
        "g": "81f07a968c7807da",
        "name": "",
        "server": "192.168.1.219",
        "port": "1030",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 2010,
        "y": 940,
        "wires": [
            [
                "5f6f957295b47d82"
            ]
        ]
    },
    {
        "id": "9008d6f89255fd25",
        "type": "tcp request",
        "z": "8dc927f2ab7dee3c",
        "g": "37db5abb5a3ef2b6",
        "name": "",
        "server": "192.168.1.209",
        "port": "1030",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 1990,
        "y": 880,
        "wires": [
            [
                "2cb5d87046cf4e48"
            ]
        ]
    },
    {
        "id": "9b34d9d0506837d4",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "g": "8150787aaa7b18c0",
        "name": "",
        "topic": "homeassistant/hvac/hitachi/+/+/mode/set",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 260,
        "y": 820,
        "wires": [
            [
                "c2dd03142f5d4aa9",
                "47aaae1ecb8daf0e"
            ]
        ]
    },
    {
        "id": "2e127fee5de3e7e6",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "g": "8150787aaa7b18c0",
        "name": "",
        "topic": "homeassistant/hvac/hitachi/+/+/temperature/set",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 240,
        "y": 860,
        "wires": [
            [
                "c2dd03142f5d4aa9",
                "47aaae1ecb8daf0e"
            ]
        ]
    },
    {
        "id": "2a28d9a5bf476a48",
        "type": "mqtt out",
        "z": "8dc927f2ab7dee3c",
        "g": "8150787aaa7b18c0",
        "name": "homeassistant/hvac/i2/+/+/mode/state",
        "topic": "",
        "qos": "1",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "751ec40a6956d4f9",
        "x": 725,
        "y": 880,
        "wires": [],
        "l": false
    },
    {
        "id": "d7731ab0b24d675f",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "g": "8150787aaa7b18c0",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 715,
        "y": 820,
        "wires": [],
        "l": false
    },
    {
        "id": "c2dd03142f5d4aa9",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "g": "8150787aaa7b18c0",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 580,
        "y": 820,
        "wires": []
    },
    {
        "id": "b45c429b43b19195",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "g": "fbc54bd83cbfb9d0",
        "name": "",
        "topic": "homeassistant/light/dual/+/+/set",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 190,
        "y": 560,
        "wires": [
            [
                "3a22374dff3a0d3a"
            ]
        ]
    },
    {
        "id": "3a22374dff3a0d3a",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "fbc54bd83cbfb9d0",
        "name": "command(dual)new",
        "func": "/**\n * é›™è‰²æº«ï¼ˆdualï¼‰æ§åˆ¶ï¼šç”¢ç”Ÿå…©ç­† Modbus æŒ‡ä»¤ï¼ˆå« CRC16ï¼‰\n * Topic: homeassistant/light/dual/{id}/{channel}/set\n * Payload: \"ON\" | \"OFF\" | boolean | number\n *\n * æŒ‡ä»¤æ ¼å¼ï¼š\n * [SLAVE_ID, 0x06, REG_HI, REG_LO, DIMMING_SPEED, VALUE, CRC_LOW, CRC_HIGH]\n *\n * é€šé“å¯„å­˜å™¨ï¼š\n * a â†’ 2090 (0x082A, äº®åº¦), 2091 (0x082B, è‰²æº«)\n * b â†’ 2092 (0x082C, äº®åº¦), 2093 (0x082D, è‰²æº«)\n */\n\nconst DEFAULT_BRIGHTNESS = 100; // 0~100\nconst DEFAULT_COLORTEMP = 250; // mired (â‰ˆ4000K)\nconst MIN_MIRED = 167, MAX_MIRED = 333;\nconst DIMMING_SPEED = 0x05;\n\nconst CHANNEL_REGISTER_MAP = {\n    \"a\": [0x082A, 0x082B], // brightness, colortemp\n    \"b\": [0x082C, 0x082D]\n};\n\n// CRC16\nfunction crc16(buf) {\n    let crc = 0xFFFF;\n    for (const b of buf) {\n        crc ^= b;\n        for (let i = 0; i < 8; i++) {\n            crc = (crc & 1) ? ((crc >> 1) ^ 0xA001) : (crc >> 1);\n        }\n    }\n    return crc;\n}\n\n// å»ºç«‹å–®ç­† 0x06 æŒ‡ä»¤\nfunction buildCommand(id, reg, value) {\n    const hi = (reg >> 8) & 0xFF;\n    const lo = reg & 0xFF;\n    let cmd = Buffer.from([id, 0x06, hi, lo, DIMMING_SPEED, value]);\n    const crc = crc16(cmd);\n    return Buffer.concat([cmd, Buffer.from([crc & 0xFF, (crc >> 8) & 0xFF])]);\n}\n\n// ===================== ä¸»æµç¨‹ =====================\nconst parts = String(msg.topic || \"\").split(\"/\");\nif (parts.length < 6 || parts[2] !== \"dual\" || parts[5] !== \"set\") return null;\n\nconst slaveId = parseInt(parts[3]) || 0;\nconst chStr = (parts[4] || \"\").toLowerCase();\nconst regs = CHANNEL_REGISTER_MAP[chStr];\nif (!regs) return null;\n\n// ç‹€æ…‹åˆ¤æ–·\nlet state = \"OFF\";\nif (msg.payload === \"ON\") state = \"ON\";\n\n// è®€å–å¿«å–\nconst brKey = `dual_${slaveId}_${chStr}_brightness`;\nconst ctKey = `dual_${slaveId}_${chStr}_colortemp`;\n\nlet brightness = flow.get(brKey);\nif (typeof brightness !== \"number\") brightness = DEFAULT_BRIGHTNESS;\nbrightness = Math.max(0, Math.min(100, Math.round(brightness)));\n\nlet colortemp = flow.get(ctKey);\nif (typeof colortemp !== \"number\") colortemp = DEFAULT_COLORTEMP;\ncolortemp = Math.max(MIN_MIRED, Math.min(MAX_MIRED, Math.round(colortemp)));\n\n// OFF = äº®åº¦æ­¸ 0\nconst brValue = (state === \"ON\") ? brightness : 0;\n\n// è‰²æº«è½‰æ› (mired â†’ 0~100)\nconst ctPercent = Math.round(((MAX_MIRED - colortemp) / (MAX_MIRED - MIN_MIRED)) * 100);\n\n// ç”¢ç”Ÿå…©ç­†æŒ‡ä»¤\nconst cmdBrightness = buildCommand(slaveId, regs[0], brValue);\nconst cmdColortemp = buildCommand(slaveId, regs[1], ctPercent);\n\n// è¼¸å‡ºå…©ç­†\nnode.send({ payload: cmdBrightness });\nnode.send({ payload: cmdColortemp });\n\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 560,
        "wires": [
            [
                "5940262c17b7a555"
            ]
        ]
    },
    {
        "id": "d736ce249ca02c8b",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "name": "è§£æå›æ‡‰(æ—¥ç«‹å†·æ°£)",
        "func": "// HVAC Feedback è§£æå™¨ï¼ˆç¨ç«‹ç‰ˆï¼Œç¬¦åˆ discovery_climate_MQTT.js çš„ topic è¦å‰‡ï¼‰\n// è¼¸å…¥ï¼šmsg.payload = Buffer (17 bytes, å·²é©—è­‰ CRC)\n// è¼¸å‡ºï¼šMQTT ç‹€æ…‹é™£åˆ— [{ topic, payload }...]\n\n// === ç‹€æ…‹å°æ‡‰è¡¨ ===\nconst HVAC_MODE_MAP = {\n    0: \"cool\",\n    1: \"heat\",\n    2: \"dry\",\n    3: \"fan_only\",\n    4: \"off\"\n};\nconst HVAC_FAN_MAP = {\n    0: \"auto\",\n    1: \"low\",\n    2: \"medium\",\n    3: \"high\"\n};\n\n// === è§£æä¸»ç¨‹å¼ ===\nconst buf = msg.payload;\nif (!Buffer.isBuffer(buf) || buf.length !== 17) return null;\n\nconst moduleId = buf[0];\nconst funcCode = buf[1];\nif (funcCode !== 0x03) return null;\n\nconst power_state = buf.readUInt16BE(3);\nconst mode_state = buf.readUInt16BE(5);\nconst fan_mode_state = buf.readUInt16BE(7);\nconst temperature_state = buf.readUInt16BE(9);\nconst current_temperature_state = buf.readUInt16BE(11);\nconst hvac_id = buf.readUInt8(14) / 8;\n\n// topic path: homeassistant/hvac/<brand>/<moduleId>/<hvac_id>\nconst brand = \"hitachi\"; // ä¾ discovery_climate_MQTT.js\nconst baseTopic = `homeassistant/hvac/${brand}/${moduleId}/${hvac_id}`;\n\nconst mode_state_str = (power_state === 0) ? \"off\" : (HVAC_MODE_MAP[mode_state] || \"off\");\nconst fan_mode_state_str = HVAC_FAN_MAP[fan_mode_state] || \"auto\";\n\nlet mqttMessages = [];\nmqttMessages.push({ topic: `${baseTopic}/mode/state`, payload: mode_state_str });\nmqttMessages.push({ topic: `${baseTopic}/fan/state`, payload: fan_mode_state_str });\nmqttMessages.push({ topic: `${baseTopic}/temperature/state`, payload: temperature_state });\nmqttMessages.push({ topic: `${baseTopic}/current_temperature`, payload: current_temperature_state });\n\nreturn [mqttMessages];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2730,
        "y": 940,
        "wires": [
            [
                "4c17d151690d8caa"
            ]
        ]
    },
    {
        "id": "d823a94093e3ebaa",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "name": "CRC é©—è­‰",
        "func": "// Node-RED Function ç¯€é»ï¼šCRC16 é©—è­‰éæ¿¾å™¨\n// è¼¸å…¥ï¼šmsg.payload = Buffer\n// é€šéé©—è­‰æ‰å¾€ä¸‹å‚³éï¼Œä¸é€šéå‰‡ä¸å‚³é\n\nfunction crc16(buf) {\n    let crc = 0xFFFF;\n    for (const b of buf) {\n        crc ^= b;\n        for (let i = 0; i < 8; i++) {\n            crc = (crc & 1) ? ((crc >> 1) ^ 0xA001) : (crc >> 1);\n        }\n    }\n    return crc;\n}\n\nfunction verifyCRC(buf) {\n    let crc = 0xFFFF;\n    for (let i = 0; i < buf.length - 2; i++) {\n        crc ^= buf[i];\n        for (let j = 0; j < 8; j++) {\n            crc = (crc & 1) ? ((crc >> 1) ^ 0xA001) : (crc >> 1);\n        }\n    }\n    const crcLow = crc & 0xFF;\n    const crcHigh = (crc >> 8) & 0xFF;\n    return (crcLow === buf[buf.length - 2]) && (crcHigh === buf[buf.length - 1]);\n}\n\nif (Buffer.isBuffer(msg.payload) && verifyCRC(msg.payload)) {\n    return msg;\n} else {\n    // é©—è­‰å¤±æ•—ä¸å¾€ä¸‹å‚³\n    return null;\n}\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2560,
        "y": 940,
        "wires": [
            [
                "d736ce249ca02c8b"
            ]
        ]
    },
    {
        "id": "aeb5d329737c210a",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "name": "è§£æå›æ‡‰(R410)",
        "func": "/**\n * Relay ç‹€æ…‹è§£æï¼ˆåƒ… Relayï¼‰\n * æ”¯æ´å›æ‡‰ï¼šModbus RTU 0x01 Read Coils\n *\n * å›æ‡‰æ ¼å¼ï¼š\n * [SLAVE_ID][0x01][BYTE_COUNT][DATA0][DATA1]...[CRC_L][CRC_H]\n * å…¶ä¸­ DATA çš„ bit0~bit3 å°æ‡‰é€šé“ 1~4\n *\n * è¼¸å‡º MQTTï¼š\n *   homeassistant/light/relay/{id}/{channel}/state\n *   payload: \"ON\" | \"OFF\"\n *\n * === å¦‚ä½•å¢åŠ é€šé“æ•¸é‡ ===\n * 1. ä¿®æ”¹ for è¿´åœˆä¸Šé™ (é è¨­ 4)\n *      for (let ch = 0; ch < 8; ch++) { ... }   // 8 é€šé“\n * 2. æ¯å¢åŠ  8 å€‹é€šé“ï¼Œæœƒå¤šç”¨åˆ° 1 å€‹ data byte\n *      ä¾‹å¦‚ 16 é€šé“ â†’ buffer[3], buffer[4] å…©å€‹ byte\n *      ä¾‹å¦‚ 24 é€šé“ â†’ buffer[3], buffer[4], buffer[5]\n * 3. ä¸éœ€æ”¹å…¶ä»–ç¨‹å¼ï¼Œå› ç‚ºä½å…ƒè§£æé‚è¼¯å·²ç¶“è™•ç†ã€Œè·¨ byteã€æƒ…æ³\n */\n\n// ---- CRC é©—è­‰ ----\nfunction verifyCRC(buf) {\n    let crc = 0xFFFF;\n    for (let i = 0; i < buf.length - 2; i++) {\n        crc ^= buf[i];\n        for (let j = 0; j < 8; j++) {\n            crc = (crc & 1) ? ((crc >> 1) ^ 0xA001) : (crc >> 1);\n        }\n    }\n    const lo = crc & 0xFF;\n    const hi = (crc >> 8) & 0xFF;\n    return lo === buf[buf.length - 2] && hi === buf[buf.length - 1];\n}\n\n// ---- ä¸»æµç¨‹ ----\nconst buf = msg.payload;\nif (!Buffer.isBuffer(buf)) return null;\nif (buf.length < 5) return null;\n\nconst id = buf[0];\nconst funcCode = buf[1];\nconst byteCnt = buf[2];\n\n// æª¢æŸ¥åŠŸèƒ½ç¢¼èˆ‡é•·åº¦\nif (funcCode !== 0x01) return null;\nif (buf.length !== 3 + byteCnt + 2) return null;\nif (!verifyCRC(buf)) return null;\n\nconst mqttMsgs = [];\n\n// === è§£æ Relay ç‹€æ…‹ ===\n// é è¨­è§£æå‰ 4 å€‹ Relay (bit0~bit3)\n// âœ å¦‚æœè¦å¢åŠ é€šé“æ•¸é‡ï¼Œä¿®æ”¹ for è¿´åœˆä¸Šé™å³å¯\nfor (let ch = 0; ch < 4; ch++) {\n    // æ¯ 8 å€‹é€šé“ä½¿ç”¨ 1 å€‹ data byte\n    const byteIndex = 3 + Math.floor(ch / 8);\n    const bitIndex = ch % 8;\n    const state = ((buf[byteIndex] >> bitIndex) & 1) ? \"ON\" : \"OFF\";\n\n    mqttMsgs.push({\n        topic: `homeassistant/light/relay/${id}/${ch + 1}/state`,\n        payload: state\n    });\n}\n\n// âœ… ä¸€æ¬¡è¼¸å‡ºå¤šç­†\nreturn [mqttMsgs];\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2720,
        "y": 1020,
        "wires": [
            [
                "4c17d151690d8caa"
            ]
        ]
    },
    {
        "id": "47aaae1ecb8daf0e",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "8150787aaa7b18c0",
        "name": "å†·æ°£è™•ç†",
        "func": "/**\n * ç©ºèª¿è™•ç†å™¨ - æ”¯æ´ HVAC æ§åˆ¶\n * \n * Node Type: function\n * \n * è¼¸å‡ºï¼š\n *   Output 1: Modbus æŒ‡ä»¤ â†’ é€£æ¥åˆ° modbus_queue.js\n *   Output 2: MQTT ç‹€æ…‹   â†’ é€£æ¥åˆ° MQTT out\n * \n * æ”¯æ´çš„ Topic æ ¼å¼:\n *   homeassistant/hvac/{s200Id}/{hvacId}/mode/set     (payload: \"cool\", \"heat\", \"dry\", \"fan_only\", \"off\")\n *   homeassistant/hvac/{s200Id}/{hvacId}/temperature/set (payload: 16-30)\n *   homeassistant/hvac/{s200Id}/{hvacId}/fan/set      (payload: \"auto\", \"low\", \"medium\", \"high\")\n */\n\n// ========== å…±ç”¨æ¨¡çµ„ ==========\n// CRC16 MODBUS\nfunction crc16(buf) {\n    let crc = 0xFFFF;\n    for (const b of buf) {\n        crc ^= b;\n        for (let i = 0; i < 8; i++) {\n            crc = (crc & 1)\n                ? ((crc >> 1) ^ 0xA001)\n                : (crc >> 1);\n        }\n    }\n    return crc;\n}\n\n// ========== å¸¸æ•¸å®šç¾© ==========\nconst MODE_MAP = {\n    \"cool\": 0,\n    \"heat\": 1,\n    \"dry\": 2,\n    \"fan_only\": 3,\n    \"off\": 4\n};\n\nconst FAN_MODE_MAP = {\n    \"auto\": 0,\n    \"low\": 1,\n    \"medium\": 2,\n    \"high\": 3\n};\n\n// ========== ä¸»è™•ç†é‚è¼¯ ==========\nconst parts = String(msg.topic || \"\").split(\"/\");\nconst deviceType = parts[1];     // hvac\nconst brand = parts[2];          // hitachi\nlet s200Id, hvacId, hvacAction;\nif (deviceType !== \"hvac\") return null;\n\nif (brand === \"hitachi\") {\n    s200Id = parseInt(parts[3]);\n    hvacId = parseInt(parts[4]);\n    hvacAction = parts[5];\n} else {\n    s200Id = parseInt(parts[2]);\n    hvacId = parseInt(parts[3]);\n    hvacAction = parts[4];\n}\nconst payload = msg.payload;\n\nconst baseAddress = 0x100;\nconst speed = 0x00;\nlet register, value;\nswitch (hvacAction) {\n    case \"mode\":\n        register = baseAddress + hvacId * 8 + 1;\n        value = MODE_MAP[payload];\n        break;\n    case \"fan\":\n        register = baseAddress + hvacId * 8 + 2;\n        value = FAN_MODE_MAP[payload];\n        break;\n    case \"temperature\":\n        register = baseAddress + hvacId * 8 + 3;\n        value = parseFloat(payload);\n        break;\n    default:\n        return null;\n}\nif (value === undefined || value === null) return null;\nconst regHi = (register >> 8) & 0xFF;\nconst regLo = register & 0xFF;\nconst cmd = Buffer.from([\n    s200Id,\n    0x06,\n    regHi,\n    regLo,\n    speed,\n    value\n]);\nconst crc = crc16(cmd);\nconst crcLow = crc & 0xFF;\nconst crcHigh = (crc >> 8) & 0xFF;\nmsg.payload = Buffer.concat([\n    cmd,\n    Buffer.from([crcLow, crcHigh])\n]);\nreturn msg;\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 860,
        "wires": [
            [
                "d7731ab0b24d675f",
                "5940262c17b7a555"
            ],
            [
                "2a28d9a5bf476a48"
            ]
        ]
    },
    {
        "id": "fcbfa886645c2380",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "g": "8150787aaa7b18c0",
        "name": "",
        "topic": "homeassistant/hvac/hitachi/+/+/fan/set",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 250,
        "y": 900,
        "wires": [
            [
                "c2dd03142f5d4aa9",
                "47aaae1ecb8daf0e"
            ]
        ]
    },
    {
        "id": "c4d17b45221b33b3",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "c0fc12864140dc9d",
        "name": "command(cover)new",
        "func": "/**\n * çª—ç°¾è™•ç†å™¨ - æ”¯æ´çª—ç°¾/æ²ç°¾/æ’ç…™çª—\n * \n * Node Type: function\n * \n * è¼¸å‡ºï¼š\n *   Output 1: Modbus æŒ‡ä»¤ â†’ é€£æ¥åˆ° modbus_queue.js\n *   Output 2: MQTT ç‹€æ…‹   â†’ é€£æ¥åˆ° MQTT out\n * \n * æ”¯æ´çš„ Topic æ ¼å¼:\n *   homeassistant/cover/general/{moduleId}/set\n *   payload: \"1_2/3\" è¡¨ç¤ºé–‹å•Ÿ relay 1 å’Œ 2ï¼Œé—œé–‰ relay 3\n */\n\n// CRC ç”± crc_builder.js è™•ç†\n\n// ========== ä¸»è™•ç†é‚è¼¯ ==========\nconst parts = String(msg.topic || \"\").split(\"/\");\nconst deviceType = parts[1];     // cover\nconst subType = parts[2];        // general, curtain\nconst moduleId = parseInt(parts[3]);\n\nif (deviceType !== \"cover\") {\n    return null;\n}\n\nlet modbusMessages = [];\n\n// æ ¼å¼: homeassistant/cover/general/12/set\n// payload: \"1_2/3\" è¡¨ç¤ºé–‹å•Ÿ relay 1 å’Œ 2ï¼Œé—œé–‰ relay 3\n\nconst relays = String(msg.payload).split(\"/\");\nconst on_relays = relays[0] ? relays[0].split(\"_\").map(Number).filter(n => !isNaN(n)) : [];\nconst off_relays = (relays[1] && relays[1].length > 0) ? relays[1].split(\"_\").map(Number).filter(n => !isNaN(n)) : [];\n\nlet output = 0x00;\nfor (let relay of on_relays) {\n    output |= (1 << (relay - 1));\n}\nfor (let relay of off_relays) {\n    output &= ~(1 << (relay - 1));\n}\n\nconst cmd = Buffer.from([moduleId, 0x06, 0x01, 0x9b, 0x10, output]);\n\nmodbusMessages.push({ payload: cmd, deviceType, moduleId, on_relays, off_relays });\n\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `Cover: ON[${on_relays}] OFF[${off_relays}]`\n});\n\nreturn [modbusMessages, []];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 700,
        "wires": [
            [
                "837248e227f3867d",
                "a72fd371fad4db7f"
            ],
            [
                "b4146696b965e6c8"
            ]
        ]
    },
    {
        "id": "be8e8d5182735965",
        "type": "mqtt in",
        "z": "8dc927f2ab7dee3c",
        "g": "c0fc12864140dc9d",
        "name": "",
        "topic": "homeassistant/cover/+/+/+/set",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 180,
        "y": 700,
        "wires": [
            [
                "c4d17b45221b33b3"
            ]
        ]
    },
    {
        "id": "b4146696b965e6c8",
        "type": "mqtt out",
        "z": "8dc927f2ab7dee3c",
        "g": "c0fc12864140dc9d",
        "name": "homeassistant/hvac/i2/+/+/mode/state",
        "topic": "",
        "qos": "1",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "751ec40a6956d4f9",
        "x": 745,
        "y": 720,
        "wires": [],
        "l": false
    },
    {
        "id": "837248e227f3867d",
        "type": "debug",
        "z": "8dc927f2ab7dee3c",
        "g": "c0fc12864140dc9d",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 725,
        "y": 680,
        "wires": [],
        "l": false
    },
    {
        "id": "a72fd371fad4db7f",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "c0fc12864140dc9d",
        "name": "CRC builder",
        "func": "/**\n * CRC16 æŒ‡ä»¤å»ºæ§‹å™¨\n * \n * Node Type: function\n * \n * è¼¸å…¥ï¼š\n *   msg.payload = Buffer (ä¸å« CRC çš„ Modbus æŒ‡ä»¤)\n * \n * è¼¸å‡ºï¼š\n *   msg.payload = Buffer (å« CRC çš„å®Œæ•´ Modbus æŒ‡ä»¤)\n * \n * ä½¿ç”¨æ–¹å¼ï¼š\n *   processor_light â†’ crc_builder â†’ modbus_queue\n */\n\nfunction crc16(buf) {\n    let crc = 0xFFFF;\n    for (const b of buf) {\n        crc ^= b;\n        for (let i = 0; i < 8; i++) {\n            crc = (crc & 1) ? ((crc >> 1) ^ 0xA001) : (crc >> 1);\n        }\n    }\n    return crc;\n}\n\n// ç¢ºä¿ payload æ˜¯ Buffer\nlet frame = msg.payload;\nif (!Buffer.isBuffer(frame)) {\n    if (Array.isArray(frame)) {\n        frame = Buffer.from(frame);\n    } else {\n        node.warn(\"è¼¸å…¥å¿…é ˆæ˜¯ Buffer æˆ– Array\");\n        return null;\n    }\n}\n\nconst crc = crc16(frame);\nmsg.payload = Buffer.concat([frame, Buffer.from([crc & 0xFF, (crc >> 8) & 0xFF])]);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 700,
        "wires": [
            [
                "5940262c17b7a555"
            ]
        ]
    },
    {
        "id": "90edd330fe6e2910",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "name": "è§£æå›æ‡‰(hmi)",
        "func": "/**\n * HMI è™•ç†å™¨ - è§¸æ§è¢å¹•æŒ‡ä»¤è§£æ\n * \n * Node ID: hmi_processor\n * Node Type: function\n * \n * æ­¤æª”æ¡ˆå¾ test_full_integrated.json è‡ªå‹•æå–\n */\n\nconst MIN_MIRED = 167, MAX_MIRED = 333;\n\nconst HMI_pattern = [\n    // ========== ç©ºèª¿æ§åˆ¶ ==========\n    // HMI ä¸æœƒç›´æ¥æ§åˆ¶å†·æ°£ï¼Œéœ€è¦ Node-RED ç™¼é€ Modbus æŒ‡ä»¤\n    // é€™è£¡ç™¼é€ set æŒ‡ä»¤è®“ processor_hvac.js è™•ç†\n    // âš ï¸ æ³¨æ„ï¼šé€™äº›æ˜¯èˆŠæ ¼å¼ï¼Œå¯èƒ½ä¸å†ä½¿ç”¨\n    {\n        name: \"hvac_power_mode\",\n        pattern: [0x01, 0x31, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const powerValue = input[2];\n            const hvacId = input[5];\n            const mode = powerValue === 0x01 ? \"cool\" : \"off\";  // é–‹æ©Ÿé è¨­å†·æ°£æ¨¡å¼\n            return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/mode/set`, payload: mode }];\n        }\n    },\n    {\n        name: \"hvac_temperature\",\n        pattern: [0x01, 0x32, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const tempValue = input[2];\n            const hvacId = input[5];\n            return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/temperature/set`, payload: String(tempValue) }];\n        }\n    },\n    {\n        name: \"hvac_mode\",\n        pattern: [0x01, 0x33, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const modeValue = input[2];\n            const hvacId = input[5];\n            const MODE_MAP = {\n                0x00: \"cool\",\n                0x01: \"dry\",\n                0x02: \"fan_only\",\n                0x04: \"heat\"\n            };\n            const mode = MODE_MAP[modeValue];\n            if (!mode) return null;\n            return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/mode/set`, payload: mode }];\n        }\n    },\n    {\n        name: \"hvac_fan_speed\",\n        pattern: [0x01, 0x34, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const fanValue = input[2];\n            const hvacId = input[5];\n            const FAN_MAP = {\n                0x03: \"medium\",\n                0x04: \"high\",\n                0x05: \"auto\",\n                0x07: \"low\"\n            };\n            const fan = FAN_MAP[fanValue];\n            if (!fan) return null;\n            return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/fan/set`, payload: fan }];\n        }\n    },\n    // HMI å¯¦éš›æ ¼å¼ - æº«åº¦æ§åˆ¶ï¼ˆASCII å­—ä¸²æ ¼å¼ï¼‰\n    // HMI ä¸æœƒç›´æ¥æ§åˆ¶å†·æ°£ï¼Œç™¼é€ set æŒ‡ä»¤è®“ processor_hvac.js è™•ç†\n    // æ ¼å¼: [0xEE, 0x00, 0x00, 0xB1, 0x12, 0x00, 0x2C, 0x00, 0x1F, 0x00, 0x02, '3', '1', ...]\n    {\n        name: \"hvac_temperature_ascii\",\n        pattern: [0xEE, 0x00, 0x00, 0xB1, 0x12, 0x00, 0x2C, 0x00, 0x1F, 0x00, null],\n        parse: (input) => {\n            // input[10] æ˜¯é•·åº¦ï¼Œå¾Œé¢æ˜¯ ASCII æº«åº¦å­—ä¸²\n            const length = input[10];\n            if (length < 1 || input.length < 11 + length) return null;\n\n            // æå– ASCII æº«åº¦å­—ä¸²ä¸¦è½‰æ›\n            let tempStr = '';\n            for (let i = 0; i < length; i++) {\n                tempStr += String.fromCharCode(input[11 + i]);\n            }\n\n            const temperature = parseInt(tempStr);\n            if (isNaN(temperature)) return null;\n\n            // å‡è¨­ HVAC ID = 1ï¼ˆå¯èƒ½éœ€è¦å¾å…¶ä»–åœ°æ–¹åˆ¤æ–·ï¼‰\n            const hvacId = 1;\n\n            return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/temperature/set`, payload: String(temperature) }];\n        }\n    },\n    // HMI å¯¦éš›æ ¼å¼ - æ¨¡å¼/é¢¨é€Ÿæ§åˆ¶\n    // HMI ä¸æœƒç›´æ¥æ§åˆ¶å†·æ°£ï¼Œç™¼é€ set æŒ‡ä»¤è®“ processor_hvac.js è™•ç†\n    // æ ¼å¼: [0xEE, 0x00, 0x65, 0xB1, 0x11, 0x00, 0x2C, 0x00, byte8, 0x10, 0x01, 0x01, ...]\n    // byte8 æ±ºå®šæ¨¡å¼æˆ–é¢¨é€Ÿ\n    {\n        name: \"hvac_mode_fanspeed\",\n        pattern: [0xEE, 0x00, 0x65, 0xB1, 0x11, 0x00, 0x2C, 0x00, null, null, null, null],\n        parse: (input) => {\n            const byte8 = input[8];   // é—œéµä½ç½®ï¼šæ±ºå®šæ¨¡å¼æˆ–é¢¨é€Ÿ\n            const byte9 = input[9];   // é€šå¸¸æ˜¯ 0x10\n            const byte10 = input[10]; // é€šå¸¸æ˜¯ 0x01\n            const byte11 = input[11]; // é€šå¸¸æ˜¯ 0x01\n\n            // å‡è¨­ HVAC ID = 1\n            const hvacId = 1;\n\n            // é–‹é—œæ§åˆ¶ï¼ˆåŸºæ–¼ byte8 å’Œ byte11ï¼‰\n            if (byte8 === 0x0A) {\n                // byte11 æ±ºå®šé–‹é—œï¼š0x00=é—œæ©Ÿ, 0x01=é–‹æ©Ÿ\n                const powerState = byte11 === 0x01 ? \"cool\" : \"off\";  // é–‹æ©Ÿé è¨­ç‚ºå†·æ°£æ¨¡å¼\n                return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/mode/set`, payload: powerState }];\n            }\n\n            // æ¨¡å¼æ˜ å°„ï¼ˆåŸºæ–¼ byte8ï¼‰\n            const MODE_MAP = {\n                0x0D: \"cool\",      // å†·æ°£\n                0x10: \"heat\",      // æš–æ°£\n                0x0E: \"dry\",       // é™¤æ¿•\n                0x0F: \"fan_only\"   // é€é¢¨\n            };\n\n            // é¢¨é€Ÿæ˜ å°„ï¼ˆåŸºæ–¼ byte8ï¼‰\n            const FAN_MAP = {\n                0x13: \"low\",       // ä½é€Ÿ\n                0x12: \"medium\",    // ä¸­é€Ÿ\n                0x11: \"high\",      // é«˜é€Ÿ\n                0x14: \"auto\"       // è‡ªå‹•\n            };\n\n            // å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºæ¨¡å¼æ§åˆ¶\n            const mode = MODE_MAP[byte8];\n            if (mode) {\n                return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/mode/set`, payload: mode }];\n            }\n\n            // å†æª¢æŸ¥æ˜¯å¦ç‚ºé¢¨é€Ÿæ§åˆ¶\n            const fan = FAN_MAP[byte8];\n            if (fan) {\n                return [{ topic: `homeassistant/hvac/hitachi/200/${hvacId}/fan/set`, payload: fan }];\n            }\n            return null;\n        }\n    }\n];\n\nfunction matchPattern(input, pattern) {\n    // å…è¨± input é•·åº¦å¤§æ–¼ç­‰æ–¼ patternï¼ˆæ”¯æ´å¯è®Šé•·åº¦è³‡æ–™ï¼‰\n    if (input.length < pattern.length) return false;\n    for (let i = 0; i < pattern.length; i++) {\n        if (pattern[i] !== null && pattern[i] !== input[i]) {\n            return false;\n        }\n    }\n    return true;\n}\n\nfunction bufferToHexArray(buf) {\n    return [...buf].map(v => \"0x\" + v.toString(16).padStart(2, \"0\").toUpperCase());\n}\n\nif (!msg.payload || !Buffer.isBuffer(msg.payload)) {\n    return null;\n}\n\nlet input = Array.from(msg.payload);\nlet result = null;\nlet matchedPattern = null;\n\nlet isHVAC = false;\nlet foundPattern = false;\nfor (const p of HMI_pattern) {\n    if (matchPattern(input, p.pattern)) {\n        matchedPattern = p.name;\n        isHVAC = /^hvac_/.test(p.name);\n        node.warn('[HMI] ç¬¦åˆ pattern: ' + p.name + (isHVAC ? 'ï¼ˆå†·æ°£ï¼‰' : 'ï¼ˆéå†·æ°£ï¼‰'));\n        result = p.parse(input);\n        foundPattern = true;\n        break;\n    }\n}\nif (!foundPattern) {\n}\n\nif (result && Array.isArray(result) && result.length > 0) {\n    return [result];\n} else {\n    return null;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2720,
        "y": 1060,
        "wires": [
            [
                "4c17d151690d8caa"
            ]
        ]
    },
    {
        "id": "7c8300e57aa079a4",
        "type": "tcp in",
        "z": "8dc927f2ab7dee3c",
        "g": "1054b9ebf82dca49",
        "name": "",
        "server": "client",
        "host": "192.168.1.209",
        "port": "1030",
        "datamode": "stream",
        "datatype": "buffer",
        "newline": "",
        "topic": "",
        "trim": false,
        "base64": false,
        "tls": "",
        "x": 2520,
        "y": 1060,
        "wires": [
            [
                "90edd330fe6e2910"
            ]
        ]
    },
    {
        "id": "8bcf34a93310e225",
        "type": "function",
        "z": "8dc927f2ab7dee3c",
        "g": "2d93e84dbc762f21",
        "name": "modbusæŒ‡ä»¤åˆ†æµ",
        "func": "//port1:å†·æ°£æŒ‡ä»¤\n//port2:å…¶ä»–æŒ‡ä»¤\nif ((msg.payload)[0] == \"200\") {\n    return [msg, null]\n}\nelse {\n    return [null, msg]\n}\n\n\nreturn msg;",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1710,
        "y": 940,
        "wires": [
            [
                "9008d6f89255fd25"
            ],
            [
                "de75cc0c82bb599c"
            ]
        ]
    },
    {
        "id": "e03c4bafb2cdf6d4",
        "type": "tcp request",
        "z": "8dc927f2ab7dee3c",
        "g": "81f07a968c7807da",
        "name": "",
        "server": "192.168.1.229",
        "port": "1030",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 2010,
        "y": 980,
        "wires": [
            [
                "5f6f957295b47d82"
            ]
        ]
    },
    {
        "id": "751ec40a6956d4f9",
        "type": "mqtt-broker",
        "name": "",
        "broker": "192.168.1.233",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    }
]