[
    {
        "id": "108057c6b0820334",
        "type": "group",
        "z": "14580213f897af9a",
        "name": "å®Œæ•´æ•´åˆæ¸¬è©¦ï¼šLight (Single/Dual/Relay) + Cover + Scene",
        "style": {
            "label": true,
            "stroke": "#7c3aed",
            "fill": "#f3e8ff",
            "fill-opacity": "0.5"
        },
        "nodes": [
            "a8db97e3282d584e",
            "50313094f488b340",
            "d59a4d2f00fac520",
            "4f08be38e8e5a989",
            "c543b1d15612a8c6",
            "846a05abdd99da9a",
            "e67cfaa863dbcbf7",
            "91359a179be62f4c",
            "d9e61560c29c49a4",
            "c7e2c547c268c2ae"
        ],
        "x": 74,
        "y": 1979,
        "w": 1172,
        "h": 514
    },
    {
        "id": "a8db97e3282d584e",
        "type": "mqtt in",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "name": "MQTT è¨‚é–±æ‰€æœ‰æ§åˆ¶",
        "topic": "homeassistant/+/+/+/+/set/#",
        "qos": "0",
        "datatype": "auto-detect",
        "broker": "751ec40a6956d4f9",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 190,
        "y": 2100,
        "wires": [
            [
                "50313094f488b340"
            ]
        ]
    },
    {
        "id": "50313094f488b340",
        "type": "function",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "name": "å®Œæ•´è™•ç†å™¨ (All Devices)",
        "func": "// å®Œæ•´ç‰ˆè™•ç†å™¨ï¼šæ”¯æ´ Single/Dual/Relay ç‡ˆå…‰ã€Coverã€Scene\n\n// Debug æ§åˆ¶ (é€é global context è¨­å®š)\nconst debugConfig = global.get('debug_config') || {\n    topic: true,        // é¡¯ç¤ºæ”¶åˆ°çš„ Topic\n    cache: true,        // é¡¯ç¤ºå¿«å–æ“ä½œ\n    modbus: true,       // é¡¯ç¤º Modbus æŒ‡ä»¤è©³æƒ…\n    mqtt: true,         // é¡¯ç¤º MQTT ç‹€æ…‹å›å ±\n    scene: true,        // é¡¯ç¤º Scene è™•ç†\n    query: true         // é¡¯ç¤º Query æŸ¥è©¢\n};\n\nfunction debugLog(category, message) {\n    if (debugConfig[category]) {\n        node.warn(message);\n    }\n}\n\nconst DEFAULT_BRIGHTNESS = 100;\nconst DEFAULT_COLORTEMP = 250;\nconst MIN_MIRED = 167;\nconst MAX_MIRED = 333;\nconst BRIGHTNESS_TIME = 0x05;\nconst CHANNEL_REGISTER_MAP = {\n    \"1\": 0x082A,\n    \"2\": 0x082B,\n    \"3\": 0x082C,\n    \"4\": 0x082D,\n    \"a\": [0x082A, 0x082B],\n    \"b\": [0x082C, 0x082D]\n};\nconst CHANNEL_COIL_MAP = {\n    \"1\": 0x0000,\n    \"2\": 0x0001,\n    \"3\": 0x0002,\n    \"4\": 0x0003\n};\n\nfunction generalCommandBuild(frame) {\n    function crc16(buf) {\n        let crc = 0xFFFF;\n        for (const b of buf) {\n            crc ^= b;\n            for (let i = 0; i < 8; i++) {\n                crc = (crc & 1) ? ((crc >> 1) ^ 0xA001) : (crc >> 1);\n            }\n        }\n        return crc;\n    }\n    const crc = crc16(frame);\n    return Buffer.concat([frame, Buffer.from([crc & 0xFF, (crc >> 8) & 0xFF])]);\n}\n\nfunction clamp(value, min, max) {\n    return value < min ? min : value > max ? max : value;\n}\n\nfunction buildCommand(moduleId, reg, value, speed = 0x05) {\n    const hi = (reg >> 8) & 0xFF;\n    const lo = reg & 0xFF;\n    const cmd = Buffer.from([moduleId, 0x06, hi, lo, speed, value]);\n    return generalCommandBuild(cmd);\n}\n\nconst parts = String(msg.topic || \"\").split(\"/\");\nconst deviceType = parts[1];     // light, cover\nconst subType = parts[2];        // single, dual, relay, scene, general\nconst moduleId = parseInt(parts[3]);\nconst channel = parts[4];\n\ndebugLog('topic', `=== æ”¶åˆ°è¨Šæ¯ ===`);\ndebugLog('topic', `Topic: ${msg.topic}`);\ndebugLog('topic', `Payload: ${msg.payload}`);\ndebugLog('topic', `Device: ${deviceType}, SubType: ${subType}, Module: ${moduleId}, Channel: ${channel}`);\n\nlet modbusMessages = [];\nlet mqttMessages = [];\n\n// ========== LIGHT DEVICE ==========\nif (deviceType === \"light\") {\n    const baseTopic = `homeassistant/light/${subType}/${moduleId}/${channel}`;\n\n    // è™•ç† set/brightness å’Œ set/colortemp\n    if (parts.length >= 7 && parts[5] === \"set\") {\n        const attribute = parts[6];\n        // Scene çš„ key æ ¼å¼ä¸åŒï¼šscene_single_12-3--12-4_brightness\n        let key;\n        if (subType === \"scene\") {\n            key = `scene_${parts[3]}_${parts[4]}_${attribute}`;\n        } else {\n            key = `${subType}_${moduleId}_${channel}_${attribute}`;\n        }\n        const val = Number(msg.payload);\n\n        if (!isNaN(val)) {\n            flow.set(key, val);\n            debugLog('cache', `å„²å­˜ ${key} = ${val}`);\n        }\n\n        if (attribute === \"brightness\" || attribute === \"colortemp\") {\n            // äº®åº¦æˆ–è‰²æº«è®Šæ›´æ™‚ï¼Œä¿æŒç•¶å‰é–‹é—œç‹€æ…‹ä¸è®Š\n            // 0% ä¸æœƒè‡ªå‹•è®Šæˆ OFFï¼Œéœ€è¦æ˜ç¢ºç™¼é€ OFF æŒ‡ä»¤æ‰æœƒé—œé–‰\n            const stateKey = `${subType}_${moduleId}_${channel}_state`;\n            const state = flow.get(stateKey) || \"ON\";\n            msg.topic = `homeassistant/light/${subType}/${moduleId}/${channel}/set`;\n            msg.payload = state;\n        } else {\n            return null;\n        }\n    }\n\n    // ===== RELAY =====\n    if (subType === \"relay\") {\n        const addr = CHANNEL_COIL_MAP[channel];\n        if (addr === undefined) {\n            debugLog('modbus', `æ‰¾ä¸åˆ° Relay é€šé“ ${channel}`);\n            return null;\n        }\n\n        const state = (msg.payload === \"ON\") ? \"ON\" : \"OFF\";\n        const valHi = (msg.payload === \"ON\") ? 0xFF : 0x00;\n        const valLo = 0x00;\n        const hi = (addr >> 8) & 0xFF;\n        const lo = addr & 0xFF;\n        const frame = Buffer.from([moduleId, 0x05, hi, lo, valHi, valLo]);\n        const cmd = generalCommandBuild(frame);\n\n        const stateKey = `${subType}_${moduleId}_${channel}_state`;\n        flow.set(stateKey, state);\n\n        debugLog('modbus', `=== Modbus æŒ‡ä»¤ (Relay) ===`);\n        debugLog('modbus', `Coil åœ°å€: 0x${addr.toString(16).padStart(4, '0')}`);\n        debugLog('modbus', `æŒ‡ä»¤: ${cmd.toString('hex')}`);\n\n        modbusMessages.push({ payload: cmd, subType, moduleId, channel, state });\n        mqttMessages.push({ topic: `${baseTopic}/state`, payload: state });\n\n        node.status({\n            fill: state === \"ON\" ? \"green\" : \"grey\",\n            shape: \"dot\",\n            text: `Relay ${moduleId}-${channel}: ${state}`\n        });\n    }\n\n    // ===== SINGLE =====\n    else if (subType === \"single\") {\n        const reg = CHANNEL_REGISTER_MAP[channel];\n        if (!reg) {\n            debugLog('modbus', `æ‰¾ä¸åˆ°é€šé“ ${channel} çš„å¯„å­˜å™¨`);\n            return null;\n        }\n\n        let state = (msg.payload === \"ON\" || msg.payload === true) ? \"ON\" : \"OFF\";\n        const stateKey = `${subType}_${moduleId}_${channel}_state`;\n        flow.set(stateKey, state);\n\n        let brightness = flow.get(`${subType}_${moduleId}_${channel}_brightness`);\n        if (typeof brightness !== \"number\") brightness = DEFAULT_BRIGHTNESS;\n        brightness = clamp(Math.round(brightness), 0, 100);\n\n        const brValue = (state === \"ON\") ? brightness : 0;\n        const speed = (state === \"OFF\") ? 0x00 : BRIGHTNESS_TIME;\n        const cmd = buildCommand(moduleId, reg, brValue, speed);\n\n        debugLog('modbus', `=== Modbus æŒ‡ä»¤ (Single) ===`);\n        debugLog('modbus', `æŒ‡ä»¤: ${cmd.toString('hex')}`);\n\n        modbusMessages.push({ payload: cmd, subType, moduleId, channel, state, brightness });\n        mqttMessages.push({ topic: `${baseTopic}/state`, payload: state });\n        if (state === \"ON\") {\n            mqttMessages.push({ topic: `${baseTopic}/brightness`, payload: brightness });\n        }\n\n        node.status({\n            fill: state === \"ON\" ? \"green\" : \"grey\",\n            shape: \"dot\",\n            text: `${moduleId}-${channel}: ${state} ${brightness}%`\n        });\n    }\n\n    // ===== DUAL =====\n    else if (subType === \"dual\") {\n        const regs = CHANNEL_REGISTER_MAP[channel];\n        if (!regs) {\n            debugLog('modbus', `æ‰¾ä¸åˆ°é€šé“ ${channel} çš„å¯„å­˜å™¨`);\n            return null;\n        }\n\n        let state = (msg.payload === \"ON\" || msg.payload === true) ? \"ON\" : \"OFF\";\n        const stateKey = `${subType}_${moduleId}_${channel}_state`;\n        flow.set(stateKey, state);\n\n        let brightness = flow.get(`${subType}_${moduleId}_${channel}_brightness`);\n        if (typeof brightness !== \"number\") brightness = DEFAULT_BRIGHTNESS;\n        brightness = clamp(Math.round(brightness), 0, 100);\n\n        let colortemp = flow.get(`${subType}_${moduleId}_${channel}_colortemp`);\n        if (typeof colortemp !== \"number\") colortemp = DEFAULT_COLORTEMP;\n        colortemp = clamp(Math.round(colortemp), MIN_MIRED, MAX_MIRED);\n        const ctPercent = Math.round(((MAX_MIRED - colortemp) / (MAX_MIRED - MIN_MIRED)) * 100);\n\n        const brValue = (state === \"ON\") ? brightness : 0;\n        const cmdBrightness = buildCommand(moduleId, regs[0], brValue);\n        const cmdColortemp = buildCommand(moduleId, regs[1], ctPercent);\n\n        debugLog('modbus', `=== Modbus æŒ‡ä»¤ (Dual) ===`);\n        debugLog('modbus', `äº®åº¦: ${cmdBrightness.toString('hex')}`);\n        debugLog('modbus', `è‰²æº«: ${cmdColortemp.toString('hex')}`);\n\n        modbusMessages.push({ payload: cmdBrightness, subType, moduleId, channel, state, brightness, colortemp });\n        modbusMessages.push({ payload: cmdColortemp, subType, moduleId, channel, state, brightness, colortemp });\n        mqttMessages.push({ topic: `${baseTopic}/state`, payload: state });\n        if (state === \"ON\") {\n            mqttMessages.push({ topic: `${baseTopic}/brightness`, payload: brightness });\n            mqttMessages.push({ topic: `${baseTopic}/colortemp`, payload: colortemp });\n        }\n\n        node.status({\n            fill: state === \"ON\" ? \"green\" : \"grey\",\n            shape: \"dot\",\n            text: `${moduleId}-${channel}: ${state} ${brightness}% ${colortemp}K`\n        });\n    }\n\n    // ===== SCENE =====\n    else if (subType === \"scene\") {\n        const sceneType = parts[3];  // single, dual\n        const lights = parts[4].split(\"--\");  // 12-1--12-2\n        const state = (msg.payload === \"ON\" || msg.payload === true) ? \"ON\" : \"OFF\";\n        \n        // Scene å¿«å– key æ ¼å¼: scene_single_12-3--12-4_brightness\n        const groupBrightnessKey = `scene_${sceneType}_${parts[4]}_brightness`;\n        const groupColortempKey = `scene_${sceneType}_${parts[4]}_colortemp`;\n        const groupBrightness = flow.get(groupBrightnessKey);\n        const groupColortemp = flow.get(groupColortempKey);\n\n        debugLog('scene', `=== Scene æ§åˆ¶ ===`);\n        debugLog('scene', `å ´æ™¯é¡å‹: ${sceneType}`);\n        debugLog('scene', `ç‡ˆå…‰åˆ—è¡¨: ${lights.join(\", \")}`);\n        debugLog('scene', `ç‹€æ…‹: ${state}`);\n\n        // ç™¼é€æŒ‡ä»¤åˆ°æ¯å€‹ç‡ˆå…‰\n        for (let light of lights) {\n            const [lightId, lightChannel] = light.split(\"-\");\n            \n            // å…ˆç›´æ¥æ›´æ–°å€‹åˆ¥ç‡ˆå…‰çš„å¿«å–ï¼ˆä¸é€é MQTTï¼‰\n            if (state === \"ON\" && groupBrightness !== undefined) {\n                flow.set(`${sceneType}_${lightId}_${lightChannel}_brightness`, groupBrightness);\n                debugLog('scene', `æ›´æ–°å¿«å–: ${sceneType}_${lightId}_${lightChannel}_brightness = ${groupBrightness}`);\n            }\n            if (state === \"ON\" && groupColortemp !== undefined && sceneType === \"dual\") {\n                flow.set(`${sceneType}_${lightId}_${lightChannel}_colortemp`, groupColortemp);\n                debugLog('scene', `æ›´æ–°å¿«å–: ${sceneType}_${lightId}_${lightChannel}_colortemp = ${groupColortemp}`);\n            }\n            \n            // ç„¶å¾Œç™¼é€é–‹é—œæŒ‡ä»¤ï¼ˆæœƒä½¿ç”¨å‰›æ›´æ–°çš„å¿«å–ï¼‰\n            const lightTopic = `homeassistant/light/${sceneType}/${lightId}/${lightChannel}/set`;\n            mqttMessages.push({ topic: lightTopic, payload: state });\n        }\n\n        // æ›´æ–°å ´æ™¯æœ¬èº«çš„ç‹€æ…‹\n        mqttMessages.push({ topic: `homeassistant/light/scene/${sceneType}/${parts[4]}/state`, payload: state });\n\n        node.status({\n            fill: state === \"ON\" ? \"yellow\" : \"grey\",\n            shape: \"ring\",\n            text: `Scene: ${lights.length} ç‡ˆ ${state}`\n        });\n    }\n}\n\n// ========== COVER DEVICE ==========\nelse if (deviceType === \"cover\") {\n    // æ ¼å¼: homeassistant/cover/general/12/set\n    // payload: \"1_2/3\" è¡¨ç¤ºé–‹å•Ÿ relay 1 å’Œ 2ï¼Œé—œé–‰ relay 3\n    \n    const relays = msg.payload.split(\"/\");\n    const on_relays = relays[0] ? relays[0].split(\"_\").map(Number) : [];\n    const off_relays = (relays[1] && relays[1].length > 0) ? relays[1].split(\"_\").map(Number) : [];\n\n    let output = 0x00;\n    for (let relay of on_relays) {\n        output |= (1 << (relay - 1));\n    }\n    for (let relay of off_relays) {\n        output &= ~(1 << (relay - 1));\n    }\n\n    const frame = Buffer.from([moduleId, 0x06, 0x01, 0x9b, 0x10, output]);\n    const cmd = generalCommandBuild(frame);\n\n    debugLog('modbus', `=== Modbus æŒ‡ä»¤ (Cover) ===`);\n    debugLog('modbus', `é–‹å•Ÿ Relay: ${on_relays.join(\", \")}`);\n    debugLog('modbus', `é—œé–‰ Relay: ${off_relays.join(\", \")}`);\n    debugLog('modbus', `Bit Mask: 0b${output.toString(2).padStart(8, '0')} (0x${output.toString(16).padStart(2, '0')})`);\n    debugLog('modbus', `æŒ‡ä»¤: ${cmd.toString('hex')}`);\n\n    modbusMessages.push({ payload: cmd, deviceType, moduleId, on_relays, off_relays });\n\n    node.status({\n        fill: \"blue\",\n        shape: \"dot\",\n        text: `Cover: ON[${on_relays}] OFF[${off_relays}]`\n    });\n}\n\n\n// ========== QUERY DEVICE (æŸ¥è©¢) ==========\nelse if (deviceType === \"query\") {\n    // æ ¼å¼: homeassistant/query/{subType}/{moduleId}/{channel}\n    // subType: single, dual, relay\n    \n    const querySubType = subType;  // single, dual, relay\n    \n    debugLog('query', `=== Query æŸ¥è©¢ ===`);\n    debugLog('query', `é¡å‹: ${querySubType}, æ¨¡çµ„: ${moduleId}, é€šé“: ${channel}`);\n    \n    let frame;\n    \n    if (querySubType === \"single\" || querySubType === \"dual\") {\n        // æŸ¥è©¢ Single/Dual Light: Read Holding Registers (0x03)\n        const reg = CHANNEL_REGISTER_MAP[channel];\n        if (!reg) {\n            debugLog('query', `æ‰¾ä¸åˆ°é€šé“ ${channel} çš„å¯„å­˜å™¨`);\n            return null;\n        }\n        \n        const startReg = Array.isArray(reg) ? reg[0] : reg;  // dual å–ç¬¬ä¸€å€‹å¯„å­˜å™¨\n        const quantity = Array.isArray(reg) ? 2 : 1;  // dual è®€ 2 å€‹ï¼Œsingle è®€ 1 å€‹\n        \n        const regHi = (startReg >> 8) & 0xFF;\n        const regLo = startReg & 0xFF;\n        const qtyHi = (quantity >> 8) & 0xFF;\n        const qtyLo = quantity & 0xFF;\n        \n        frame = Buffer.from([moduleId, 0x03, regHi, regLo, qtyHi, qtyLo]);\n        \n        debugLog('query', `è®€å–å¯„å­˜å™¨: 0x${startReg.toString(16).padStart(4, '0')}, æ•¸é‡: ${quantity}`);\n    }\n    else if (querySubType === \"relay\") {\n        // æŸ¥è©¢ Relay: Read Coils (0x01)\n        const addr = CHANNEL_COIL_MAP[channel] || 0x0000;\n        const quantity = 4;  // è®€å– 4 å€‹ coils\n        \n        const addrHi = (addr >> 8) & 0xFF;\n        const addrLo = addr & 0xFF;\n        const qtyHi = (quantity >> 8) & 0xFF;\n        const qtyLo = quantity & 0xFF;\n        \n        frame = Buffer.from([moduleId, 0x01, addrHi, addrLo, qtyHi, qtyLo]);\n        \n        debugLog('query', `è®€å–ç·šåœˆ: 0x${addr.toString(16).padStart(4, '0')}, æ•¸é‡: ${quantity}`);\n    }\n    else {\n        debugLog('query', `ä¸æ”¯æ´çš„æŸ¥è©¢é¡å‹: ${querySubType}`);\n        return null;\n    }\n    \n    const cmd = generalCommandBuild(frame);\n    \n    debugLog('modbus', `=== Modbus æŸ¥è©¢æŒ‡ä»¤ ===`);\n    debugLog('modbus', `æŒ‡ä»¤: ${cmd.toString('hex')}`);\n    \n    // å°‡æŸ¥è©¢è³‡è¨Šé™„åŠ åˆ°æ¯å€‹è¨Šæ¯ä¸­ï¼Œä¾› Feedback ä½¿ç”¨\n    const queryMsg = { \n        payload: cmd, \n        deviceType: \"query\", \n        subType: querySubType, \n        moduleId, \n        channel,\n        queryInfo: { type: querySubType, channel: channel }\n    };\n    modbusMessages.push(queryMsg);\n    \n    node.status({\n        fill: \"cyan\",\n        shape: \"ring\",\n        text: `Query ${querySubType} ${moduleId}-${channel}`\n    });\n}\n\n\nelse {\n    debugLog('topic', `ä¸æ”¯æ´çš„è¨­å‚™é¡å‹: ${deviceType}`);\n    return null;\n}\n\n// è¿”å›: [Modbus æŒ‡ä»¤, MQTT ç‹€æ…‹]\nreturn [modbusMessages, mqttMessages];",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "node.warn(\"=== åˆå§‹åŒ–å®Œæ•´æ¸¬è©¦ç³»çµ± ===\");",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 2100,
        "wires": [
            [
                "d59a4d2f00fac520",
                "4f08be38e8e5a989"
            ],
            [
                "91359a179be62f4c",
                "e67cfaa863dbcbf7"
            ]
        ]
    },
    {
        "id": "d59a4d2f00fac520",
        "type": "debug",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "name": "Modbus æŒ‡ä»¤",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 670,
        "y": 2020,
        "wires": []
    },
    {
        "id": "4f08be38e8e5a989",
        "type": "tcp request",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "name": "TCP â†’ Modbus",
        "server": "192.168.1.208",
        "port": "502",
        "out": "time",
        "ret": "buffer",
        "splitc": "0",
        "newline": "",
        "trim": false,
        "tls": "",
        "x": 660,
        "y": 2080,
        "wires": [
            [
                "c543b1d15612a8c6"
            ]
        ]
    },
    {
        "id": "c543b1d15612a8c6",
        "type": "function",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "name": "Feedback è™•ç†å™¨ + ç‹€æ…‹è§£æ",
        "func": "// å®Œæ•´ Feedback è™•ç†å™¨ï¼šè§£æ Modbus å›æ‡‰ä¸¦ç™¼å¸ƒ MQTT ç‹€æ…‹\n\n// Debug æ§åˆ¶\nconst debugConfig = global.get('debug_config') || {\n    topic: true,\n    cache: true,\n    modbus: true,\n    mqtt: true,\n    scene: true,\n    query: true\n};\n\nfunction debugLog(category, message) {\n    if (debugConfig[category]) {\n        node.warn(message);\n    }\n}\n\nfunction verifyCRC(buf) {\n    let crc = 0xFFFF;\n    for (let i = 0; i < buf.length - 2; i++) {\n        crc ^= buf[i];\n        for (let j = 0; j < 8; j++) {\n            crc = (crc & 1) ? ((crc >> 1) ^ 0xA001) : (crc >> 1);\n        }\n    }\n    const lo = crc & 0xFF;\n    const hi = (crc >> 8) & 0xFF;\n    return lo === buf[buf.length - 2] && hi === buf[buf.length - 1];\n}\n\nconst buf = msg.payload;\n\nif (!Buffer.isBuffer(buf) || buf.length < 5) {\n    debugLog('modbus', \"å›æ‡‰æ ¼å¼éŒ¯èª¤\");\n    return null;\n}\n\nif (!verifyCRC(buf)) {\n    debugLog('modbus', \"CRC é©—è­‰å¤±æ•—\");\n    return null;\n}\n\nconst moduleId = buf[0];\nconst funcCode = buf[1];\n\ndebugLog('modbus', `=== Modbus å›æ‡‰ ===`);\ndebugLog('modbus', `æ¨¡çµ„ID: ${moduleId}`);\ndebugLog('modbus', `åŠŸèƒ½ç¢¼: 0x${funcCode.toString(16).padStart(2, '0')}`);\n\nconst CHANNEL_REGISTER_MAP = {\n    0x082A: { type: \"single\", channel: \"1\" },\n    0x082B: { type: \"single\", channel: \"2\" },\n    0x082C: { type: \"single\", channel: \"3\" },\n    0x082D: { type: \"single\", channel: \"4\" }\n};\n\nconst DUAL_REGISTER_MAP = {\n    0x082A: { type: \"dual\", channel: \"a\", attribute: \"brightness\" },\n    0x082B: { type: \"dual\", channel: \"a\", attribute: \"colortemp\" },\n    0x082C: { type: \"dual\", channel: \"b\", attribute: \"brightness\" },\n    0x082D: { type: \"dual\", channel: \"b\", attribute: \"colortemp\" }\n};\n\nconst RELAY_COIL_MAP = {\n    0x0000: { channel: \"1\" },\n    0x0001: { channel: \"2\" },\n    0x0002: { channel: \"3\" },\n    0x0003: { channel: \"4\" }\n};\n\nlet mqttMessages = [];\n\n// ===== 0x06 Write Single Register (Single/Dual Light) =====\nif (funcCode === 0x06) {\n    const regHi = buf[2];\n    const regLo = buf[3];\n    const speedOrCoil = buf[4];\n    const valueOrCoil = buf[5];\n    const register = (regHi << 8) | regLo;\n    \n    debugLog('modbus', `å¯„å­˜å™¨: 0x${register.toString(16).padStart(4, '0')}, æ•¸å€¼: ${valueOrCoil}`);\n    \n    const registerInfo = CHANNEL_REGISTER_MAP[register] || DUAL_REGISTER_MAP[register];\n    \n    if (registerInfo) {\n        const { type, channel, attribute } = registerInfo;\n        const brightness = valueOrCoil;  // æœ€å¾Œä¸€å€‹ byte æ˜¯äº®åº¦å€¼\n        const state = brightness > 0 ? \"ON\" : \"OFF\";\n        \n        const baseTopic = `homeassistant/light/${type}/${moduleId}/${channel}`;\n        \n        debugLog('modbus', `=== è§£æ ${type.toUpperCase()} ç‡ˆå…‰ ===`);\n        debugLog('modbus', `é€šé“: ${channel}, ç‹€æ…‹: ${state}, äº®åº¦: ${brightness}`);\n        \n        if (type === \"single\") {\n            // Single Light: ç™¼å¸ƒç‹€æ…‹å’Œäº®åº¦\n            mqttMessages.push({ topic: `${baseTopic}/state`, payload: state });\n            if (state === \"ON\") {\n                mqttMessages.push({ topic: `${baseTopic}/brightness`, payload: brightness });\n            }\n            \n            // æ›´æ–°å¿«å–ï¼šOFF æ™‚ä¸æ›´æ–°äº®åº¦å¿«å–ï¼Œä¿ç•™ä¸Šæ¬¡çš„äº®åº¦å€¼\n            flow.set(`single_${moduleId}_${channel}_state`, state);\n            if (brightness > 0) {\n                flow.set(`single_${moduleId}_${channel}_brightness`, brightness);\n                debugLog('cache', `æ›´æ–°äº®åº¦å¿«å–: single_${moduleId}_${channel}_brightness = ${brightness}`);\n            } else {\n                debugLog('cache', `äº®åº¦ç‚º 0ï¼Œä¿ç•™åŸå¿«å–å€¼: ${flow.get(`single_${moduleId}_${channel}_brightness`)}`);\n            }\n            \n            debugLog('mqtt', `ç™¼å¸ƒç‹€æ…‹: ${baseTopic}/state = ${state}`);\n            if (state === \"ON\") {\n                debugLog('mqtt', `ç™¼å¸ƒäº®åº¦: ${baseTopic}/brightness = ${brightness}`);\n            }\n        } else if (type === \"dual\") {\n            // Dual Light: åˆ†åˆ¥è™•ç†äº®åº¦å’Œè‰²æº«\n            if (attribute === \"brightness\") {\n                mqttMessages.push({ topic: `${baseTopic}/state`, payload: state });\n                if (state === \"ON\") {\n                    mqttMessages.push({ topic: `${baseTopic}/brightness`, payload: brightness });\n                }\n                flow.set(`dual_${moduleId}_${channel}_state`, state);\n                // OFF æ™‚ä¸æ›´æ–°äº®åº¦å¿«å–ï¼Œä¿ç•™ä¸Šæ¬¡çš„äº®åº¦å€¼\n                if (brightness > 0) {\n                    flow.set(`dual_${moduleId}_${channel}_brightness`, brightness);\n                    debugLog('cache', `æ›´æ–°äº®åº¦å¿«å–: dual_${moduleId}_${channel}_brightness = ${brightness}`);\n                } else {\n                    debugLog('cache', `äº®åº¦ç‚º 0ï¼Œä¿ç•™åŸå¿«å–å€¼: ${flow.get(`dual_${moduleId}_${channel}_brightness`)}`);\n                }\n                \n                debugLog('mqtt', `ç™¼å¸ƒç‹€æ…‹: ${baseTopic}/state = ${state}`);\n            } else if (attribute === \"colortemp\") {\n                // è‰²æº«ç™¾åˆ†æ¯”è½‰å› mired\n                const ctPercent = valueOrCoil;\n                const MIN_MIRED = 167;\n                const MAX_MIRED = 333;\n                const colortemp = Math.round(MAX_MIRED - (ctPercent / 100) * (MAX_MIRED - MIN_MIRED));\n                \n                mqttMessages.push({ topic: `${baseTopic}/colortemp`, payload: colortemp });\n                flow.set(`dual_${moduleId}_${channel}_colortemp`, colortemp);\n                \n                debugLog('mqtt', `ç™¼å¸ƒè‰²æº«: ${baseTopic}/colortemp = ${colortemp} mired (${ctPercent}%)`);\n            }\n        }\n        \n        node.status({\n            fill: state === \"ON\" ? \"green\" : \"grey\",\n            shape: \"dot\",\n            text: `${type} ${moduleId}-${channel}: ${state} ${brightness}%`\n        });\n    }\n}\n\n// ===== 0x05 Write Single Coil (Relay) =====\nelse if (funcCode === 0x05) {\n    const regHi = buf[2];\n    const regLo = buf[3];\n    const speedOrCoil = buf[4];\n    const register = (regHi << 8) | regLo;\n    \n    debugLog('modbus', `Coil: 0x${register.toString(16).padStart(4, '0')}`);\n    \n    const coilInfo = RELAY_COIL_MAP[register];\n    \n    if (coilInfo) {\n        const { channel } = coilInfo;\n        const state = speedOrCoil === 0xFF ? \"ON\" : \"OFF\";  // 0xFF00 = ON, 0x0000 = OFF\n        \n        const baseTopic = `homeassistant/light/relay/${moduleId}/${channel}`;\n        \n        debugLog('modbus', `=== è§£æ RELAY ===`);\n        debugLog('modbus', `é€šé“: ${channel}, ç‹€æ…‹: ${state}`);\n        \n        mqttMessages.push({ topic: `${baseTopic}/state`, payload: state });\n        flow.set(`relay_${moduleId}_${channel}_state`, state);\n        \n        debugLog('mqtt', `ç™¼å¸ƒç‹€æ…‹: ${baseTopic}/state = ${state}`);\n        \n        node.status({\n            fill: state === \"ON\" ? \"green\" : \"grey\",\n            shape: \"ring\",\n            text: `Relay ${moduleId}-${channel}: ${state}`\n        });\n    }\n}\n\n// ===== 0x03 Read Holding Registers (æŸ¥è©¢å›æ‡‰) =====\nelse if (funcCode === 0x03) {\n    const byteCount = buf[2];  // å›å‚³çš„ byte æ•¸é‡\n    \n    debugLog('modbus', `=== æŸ¥è©¢å›æ‡‰ (0x03 Read Holding Registers) ===`);\n    debugLog('modbus', `æ¨¡çµ„ID: ${moduleId}, Byte Count: ${byteCount}`);\n    \n    // è§£æå¯„å­˜å™¨æ•¸æ“š (æ ¼å¼: [æ¨¡çµ„ID] [0x03] [Byte Count] [Reg1 Hi] [Reg1 Lo] [Reg2 Hi] [Reg2 Lo] ... [CRC])\n    if (byteCount >= 2) {\n        const reg1Hi = buf[3];\n        const reg1Lo = buf[4];\n        const reg1Value = (reg1Hi << 8) | reg1Lo;\n        const brightness = reg1Lo;  // ä½ä½å…ƒçµ„æ˜¯äº®åº¦å€¼\n        const state = brightness > 0 ? \"ON\" : \"OFF\";\n        \n        debugLog('modbus', `ç¬¬ä¸€å€‹å¯„å­˜å™¨å€¼: 0x${reg1Value.toString(16).padStart(4, '0')} (äº®åº¦: ${brightness})`);\n        \n        // å¾ msg.payload ä¸­å–å¾—åŸå§‹æŸ¥è©¢çš„å¯„å­˜å™¨åœ°å€ï¼ˆéœ€è¦å¾ç™¼é€æ™‚å„²å­˜ï¼‰\n        // æˆ–è€…æˆ‘å€‘å¯ä»¥æ ¹æ“šæ¨¡çµ„IDå’Œé€šé“ä¾†æ¨æ–·\n        // é€™è£¡æˆ‘å€‘å‡è¨­æŸ¥è©¢ single light channel 1 (0x082A)\n        // æ›´å¥½çš„åšæ³•æ˜¯åœ¨ç™¼é€æŸ¥è©¢æ™‚å°‡å¯„å­˜å™¨åœ°å€é™„åŠ åˆ° msg ä¸­\n        \n        // å¾ msg ä¸­å–å¾—æŸ¥è©¢æ™‚çš„è¨­å‚™è³‡è¨Šï¼ˆç”± Full Processor å‚³éï¼‰\n        const queryInfo = msg.queryInfo || {};\n        const type = queryInfo.type || \"single\";\n        const channel = queryInfo.channel || \"1\";\n        const baseTopic = `homeassistant/light/${type}/${moduleId}/${channel}`;\n        \n        debugLog('modbus', `æŸ¥è©¢çµæœ: ${type} ç‡ˆå…‰, é€šé“ ${channel}`);\n        debugLog('modbus', `ç‹€æ…‹: ${state}, äº®åº¦: ${brightness}`);\n        \n        // ç™¼å¸ƒæŸ¥è©¢åˆ°çš„ç‹€æ…‹\n        mqttMessages.push({ topic: `${baseTopic}/state`, payload: state });\n        if (state === \"ON\") {\n            mqttMessages.push({ topic: `${baseTopic}/brightness`, payload: brightness });\n        }\n        \n        // æ›´æ–°å¿«å–ï¼šæŸ¥è©¢æ™‚å¦‚æœäº®åº¦ç‚º 0ï¼Œä¹Ÿä¸æ›´æ–°äº®åº¦å¿«å–\n        flow.set(`${type}_${moduleId}_${channel}_state`, state);\n        if (brightness > 0) {\n            flow.set(`${type}_${moduleId}_${channel}_brightness`, brightness);\n            debugLog('cache', `æŸ¥è©¢æ›´æ–°äº®åº¦å¿«å–: ${type}_${moduleId}_${channel}_brightness = ${brightness}`);\n        } else {\n            debugLog('cache', `æŸ¥è©¢äº®åº¦ç‚º 0ï¼Œä¿ç•™åŸå¿«å–å€¼: ${flow.get(`${type}_${moduleId}_${channel}_brightness`)}`);\n        }\n        \n        debugLog('mqtt', `æŸ¥è©¢ç™¼å¸ƒ: ${baseTopic}/state = ${state}`);\n        if (state === \"ON\") {\n            debugLog('mqtt', `æŸ¥è©¢ç™¼å¸ƒäº®åº¦: ${baseTopic}/brightness = ${brightness}`);\n        }\n        \n        // å¦‚æœæœ‰ç¬¬äºŒå€‹å¯„å­˜å™¨ (Dual Light è‰²æº«)\n        if (byteCount >= 4) {\n            const reg2Hi = buf[5];\n            const reg2Lo = buf[6];\n            const reg2Value = (reg2Hi << 8) | reg2Lo;\n            const ctPercent = reg2Lo;\n            \n            debugLog('modbus', `ç¬¬äºŒå€‹å¯„å­˜å™¨å€¼: 0x${reg2Value.toString(16).padStart(4, '0')} (è‰²æº«%: ${ctPercent})`);\n            \n            const MIN_MIRED = 167;\n            const MAX_MIRED = 333;\n            const colortemp = Math.round(MAX_MIRED - (ctPercent / 100) * (MAX_MIRED - MIN_MIRED));\n            \n            // å¦‚æœæ˜¯ dual lightï¼Œç™¼å¸ƒè‰²æº«\n            if (type === \"dual\") {\n                mqttMessages.push({ topic: `${baseTopic}/colortemp`, payload: colortemp });\n                flow.set(`dual_${moduleId}_${channel}_colortemp`, colortemp);\n                debugLog('mqtt', `æŸ¥è©¢ç™¼å¸ƒè‰²æº«: ${baseTopic}/colortemp = ${colortemp} mired`);\n            }\n        }\n        \n        node.status({\n            fill: state === \"ON\" ? \"cyan\" : \"grey\",\n            shape: \"ring\",\n            text: `Query: ${type} ${moduleId}-${channel}: ${state} ${brightness}%`\n        });\n    }\n}\n\n// ===== 0x01 Read Coils (Relay æŸ¥è©¢å›æ‡‰) =====\nelse if (funcCode === 0x01) {\n    const byteCount = buf[2];\n    const coilStatus = buf[3];  // Coil ç‹€æ…‹ (bit mask)\n    \n    debugLog('modbus', `=== æŸ¥è©¢å›æ‡‰ (0x01 Read Coils) ===`);\n    debugLog('modbus', `æ¨¡çµ„ID: ${moduleId}, Coil ç‹€æ…‹: 0b${coilStatus.toString(2).padStart(8, '0')}`);\n    \n    // è§£ææ¯å€‹ Relay çš„ç‹€æ…‹\n    for (let i = 0; i < 4; i++) {\n        const channel = String(i + 1);\n        const state = (coilStatus & (1 << i)) ? \"ON\" : \"OFF\";\n        const baseTopic = `homeassistant/light/relay/${moduleId}/${channel}`;\n        \n        mqttMessages.push({ topic: `${baseTopic}/state`, payload: state });\n        flow.set(`relay_${moduleId}_${channel}_state`, state);\n        \n        debugLog('mqtt', `æŸ¥è©¢ç™¼å¸ƒ Relay: ${baseTopic}/state = ${state}`);\n    }\n    \n    node.status({\n        fill: \"cyan\",\n        shape: \"ring\",\n        text: `Query: Relay ${moduleId} (1-4)`\n    });\n}\n\nmsg.feedback = {\n    moduleId,\n    funcCode,\n    raw: buf.toString('hex')\n};\n\n// è¿”å›: [Feedback è³‡è¨Š, MQTT ç‹€æ…‹]\nreturn [msg, mqttMessages];",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 880,
        "y": 2080,
        "wires": [
            [
                "846a05abdd99da9a"
            ],
            [
                "e67cfaa863dbcbf7",
                "91359a179be62f4c"
            ]
        ]
    },
    {
        "id": "846a05abdd99da9a",
        "type": "debug",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "name": "Feedback è§£æ",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "feedback",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1120,
        "y": 2060,
        "wires": []
    },
    {
        "id": "e67cfaa863dbcbf7",
        "type": "mqtt out",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "name": "MQTT ç™¼å¸ƒç‹€æ…‹",
        "topic": "",
        "qos": "0",
        "retain": "true",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "751ec40a6956d4f9",
        "x": 1120,
        "y": 2120,
        "wires": []
    },
    {
        "id": "91359a179be62f4c",
        "type": "debug",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "name": "MQTT ç‹€æ…‹å›å ±",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1120,
        "y": 2180,
        "wires": []
    },
    {
        "id": "d9e61560c29c49a4",
        "type": "comment",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "name": "å®Œæ•´æ¸¬è©¦ï¼šæ‰€æœ‰è¨­å‚™é¡å‹ (Light: Single/Dual/Relay, Cover, Scene)",
        "info": "æ”¯æ´çš„è¨­å‚™é¡å‹ï¼š\n\nğŸ”† **Light - Single**\n   - Topic: homeassistant/light/single/{module}/{channel}/set\n   - å–®è‰²ç‡ˆæ§åˆ¶ (äº®åº¦)\n\nğŸ”† **Light - Dual**\n   - Topic: homeassistant/light/dual/{module}/{channel}/set\n   - é›™è‰²æº«ç‡ˆæ§åˆ¶ (äº®åº¦ + è‰²æº«)\n\nğŸ”† **Light - Relay**\n   - Topic: homeassistant/light/relay/{module}/{channel}/set\n   - ç¹¼é›»å™¨é–‹é—œ (ON/OFF)\n\nğŸ¬ **Light - Scene**\n   - Topic: homeassistant/light/scene/{type}/{lights}/set\n   - å ´æ™¯æ§åˆ¶ (æ‰¹æ¬¡æ§åˆ¶å¤šå€‹ç‡ˆ)\n   - ä¾‹å¦‚: scene/single/12-1--12-2/set\n\nğŸªŸ **Cover**\n   - Topic: homeassistant/cover/general/{module}/set\n   - Payload: \"1_2/3\" (é–‹å•Ÿ 1,2 é—œé–‰ 3)\n   - çª—ç°¾æ§åˆ¶ (Bit Mask)\n\nâœ… å®Œæ•´æµç¨‹ï¼š\n   MQTT In â†’ è™•ç†å™¨ â†’ Modbus â†’ Feedback â†’ MQTT Out\n\nâŒ ç„¡ Queue ç³»çµ± (ç›´æ¥ç™¼é€)",
        "x": 330,
        "y": 2020,
        "wires": []
    },
    {
        "id": "c7e2c547c268c2ae",
        "type": "group",
        "z": "14580213f897af9a",
        "g": "108057c6b0820334",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "a141b323b80a0134",
            "9aa235d2b9190db5",
            "57b409a6f5cfbcaf",
            "f40af533710f330a",
            "07ecc86a82f9ad28",
            "6f24912e538c90e0",
            "7c65dae1fa6a5b17",
            "4f34c7547448a4f3"
        ],
        "x": 114,
        "y": 2219,
        "w": 928,
        "h": 248
    },
    {
        "id": "a141b323b80a0134",
        "type": "inject",
        "z": "14580213f897af9a",
        "g": "c7e2c547c268c2ae",
        "name": "Debug å…¨é–‹",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"topic\":true,\"cache\":true,\"modbus\":true,\"mqtt\":true,\"scene\":true,\"query\":true}",
        "payloadType": "json",
        "x": 230,
        "y": 2300,
        "wires": [
            [
                "f40af533710f330a"
            ]
        ]
    },
    {
        "id": "9aa235d2b9190db5",
        "type": "inject",
        "z": "14580213f897af9a",
        "g": "c7e2c547c268c2ae",
        "name": "Debug å…¨é—œ",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"topic\":false,\"cache\":false,\"modbus\":false,\"mqtt\":false,\"scene\":false,\"query\":false}",
        "payloadType": "json",
        "x": 230,
        "y": 2340,
        "wires": [
            [
                "f40af533710f330a"
            ]
        ]
    },
    {
        "id": "57b409a6f5cfbcaf",
        "type": "inject",
        "z": "14580213f897af9a",
        "g": "c7e2c547c268c2ae",
        "name": "åªçœ‹ Modbus",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"topic\":false,\"cache\":false,\"modbus\":true,\"mqtt\":false,\"scene\":false,\"query\":false}",
        "payloadType": "json",
        "x": 240,
        "y": 2380,
        "wires": [
            [
                "f40af533710f330a"
            ]
        ]
    },
    {
        "id": "f40af533710f330a",
        "type": "function",
        "z": "14580213f897af9a",
        "g": "c7e2c547c268c2ae",
        "name": "è¨­å®š Debug é…ç½®",
        "func": "const config = msg.payload;\nglobal.set('debug_config', config);\n\nnode.warn('=== Debug é…ç½®å·²æ›´æ–° ===');\nnode.warn(`Topic: ${config.topic ? 'ON' : 'OFF'}`);\nnode.warn(`Cache: ${config.cache ? 'ON' : 'OFF'}`);\nnode.warn(`Modbus: ${config.modbus ? 'ON' : 'OFF'}`);\nnode.warn(`MQTT: ${config.mqtt ? 'ON' : 'OFF'}`);\nnode.warn(`Scene: ${config.scene ? 'ON' : 'OFF'}`);\n\nnode.status({\n    fill: 'green',\n    shape: 'dot',\n    text: `å·²æ›´æ–° Debug é…ç½®`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 2340,
        "wires": [
            []
        ]
    },
    {
        "id": "07ecc86a82f9ad28",
        "type": "inject",
        "z": "14580213f897af9a",
        "g": "c7e2c547c268c2ae",
        "name": "é¡¯ç¤º Debug é…ç½®",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 250,
        "y": 2420,
        "wires": [
            [
                "6f24912e538c90e0"
            ]
        ]
    },
    {
        "id": "6f24912e538c90e0",
        "type": "function",
        "z": "14580213f897af9a",
        "g": "c7e2c547c268c2ae",
        "name": "é¡¯ç¤ºç•¶å‰ Debug é…ç½®",
        "func": "const config = global.get('debug_config') || {\n    topic: true,\n    cache: true,\n    modbus: true,\n    mqtt: true,\n    scene: true,\n    query: true\n};\n\nnode.warn('=== ç•¶å‰ Debug é…ç½® ===');\nnode.warn(`Topic: ${config.topic ? 'âœ… ON' : 'âŒ OFF'}`);\nnode.warn(`Cache: ${config.cache ? 'âœ… ON' : 'âŒ OFF'}`);\nnode.warn(`Modbus: ${config.modbus ? 'âœ… ON' : 'âŒ OFF'}`);\nnode.warn(`MQTT: ${config.mqtt ? 'âœ… ON' : 'âŒ OFF'}`);\nnode.warn(`Scene: ${config.scene ? 'âœ… ON' : 'âŒ OFF'}`);\\nnode.warn(`Query: ${config.query ? 'âœ… ON' : 'âŒ OFF'}`);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 2420,
        "wires": [
            []
        ]
    },
    {
        "id": "7c65dae1fa6a5b17",
        "type": "comment",
        "z": "14580213f897af9a",
        "g": "c7e2c547c268c2ae",
        "name": "Debug æ§åˆ¶ï¼šå‹•æ…‹åˆ‡æ› debug è¨Šæ¯é¡¯ç¤º",
        "info": "é€é global.debug_config æ§åˆ¶è¦é¡¯ç¤ºå“ªäº› debug è¨Šæ¯\n\nå¯æ§åˆ¶çš„é¡åˆ¥ï¼š\n- topic: é¡¯ç¤ºæ”¶åˆ°çš„ Topic å’Œ Payload\n- cache: é¡¯ç¤ºå¿«å–æ“ä½œ\n- modbus: é¡¯ç¤º Modbus æŒ‡ä»¤è©³æƒ…\n- mqtt: é¡¯ç¤º MQTT ç‹€æ…‹å›å ±\n- scene: é¡¯ç¤º Scene è™•ç†\n\nå¿«é€Ÿåˆ‡æ›ï¼š\n- å…¨é–‹ï¼šæ‰€æœ‰ debug è¨Šæ¯\n- å…¨é—œï¼šé—œé–‰æ‰€æœ‰ debug è¨Šæ¯\n- åªçœ‹ Modbusï¼šåªé¡¯ç¤º Modbus æŒ‡ä»¤",
        "x": 290,
        "y": 2260,
        "wires": []
    },
    {
        "id": "4f34c7547448a4f3",
        "type": "group",
        "z": "14580213f897af9a",
        "g": "c7e2c547c268c2ae",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "bb3e2d1c2307f4df",
            "988f47b73f552cb9",
            "86383c3eec09415a",
            "6fde0ff84f70efdf"
        ],
        "x": 594,
        "y": 2319,
        "w": 422,
        "h": 122
    },
    {
        "id": "bb3e2d1c2307f4df",
        "type": "inject",
        "z": "14580213f897af9a",
        "g": "4f34c7547448a4f3",
        "name": "æ¸…é™¤å¿«å–",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 700,
        "y": 2360,
        "wires": [
            [
                "988f47b73f552cb9"
            ]
        ]
    },
    {
        "id": "988f47b73f552cb9",
        "type": "function",
        "z": "14580213f897af9a",
        "g": "4f34c7547448a4f3",
        "name": "æ¸…é™¤æ‰€æœ‰å¿«å–",
        "func": "const keys = flow.keys();\nlet count = 0;\nkeys.forEach(k => {\n    if (k.startsWith('single_') || k.startsWith('dual_') || k.startsWith('relay_') || k.startsWith('scene_')) {\n        flow.set(k, undefined);\n        node.warn(`æ¸…é™¤: ${k}`);\n        count++;\n    }\n});\nnode.warn(`=== å·²æ¸…é™¤ ${count} ç­†å¿«å– ===`);\nnode.status({\n    fill: \"blue\",\n    shape: \"ring\",\n    text: `å·²æ¸…é™¤ ${count} ç­†`\n});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 2360,
        "wires": [
            []
        ]
    },
    {
        "id": "86383c3eec09415a",
        "type": "inject",
        "z": "14580213f897af9a",
        "g": "4f34c7547448a4f3",
        "name": "é¡¯ç¤ºå¿«å–",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 700,
        "y": 2400,
        "wires": [
            [
                "6fde0ff84f70efdf"
            ]
        ]
    },
    {
        "id": "6fde0ff84f70efdf",
        "type": "function",
        "z": "14580213f897af9a",
        "g": "4f34c7547448a4f3",
        "name": "é¡¯ç¤ºæ‰€æœ‰å¿«å–",
        "func": "node.warn(\"=== Flow Context å…§å®¹ ===\");\nconst keys = flow.keys();\nconst filtered = keys.filter(k => \n    k.startsWith('single_') || \n    k.startsWith('dual_') || \n    k.startsWith('relay_') || \n    k.startsWith('scene_')\n);\n\nif (filtered.length === 0) {\n    node.warn(\"ç›®å‰æ²’æœ‰ä»»ä½•å¿«å–è³‡æ–™\");\n} else {\n    // åˆ†é¡é¡¯ç¤º\n    const groups = {\n        single: [],\n        dual: [],\n        relay: [],\n        scene: []\n    };\n    \n    filtered.forEach(k => {\n        const value = flow.get(k);\n        if (k.startsWith('single_')) groups.single.push(`${k}: ${value}`);\n        else if (k.startsWith('dual_')) groups.dual.push(`${k}: ${value}`);\n        else if (k.startsWith('relay_')) groups.relay.push(`${k}: ${value}`);\n        else if (k.startsWith('scene_')) groups.scene.push(`${k}: ${value}`);\n    });\n    \n    if (groups.single.length > 0) {\n        node.warn(\"--- Single ---\");\n        groups.single.forEach(s => node.warn(s));\n    }\n    if (groups.dual.length > 0) {\n        node.warn(\"--- Dual ---\");\n        groups.dual.forEach(s => node.warn(s));\n    }\n    if (groups.relay.length > 0) {\n        node.warn(\"--- Relay ---\");\n        groups.relay.forEach(s => node.warn(s));\n    }\n    if (groups.scene.length > 0) {\n        node.warn(\"--- Scene ---\");\n        groups.scene.forEach(s => node.warn(s));\n    }\n    \n    node.warn(`=== å…± ${filtered.length} ç­†å¿«å– ===`);\n}\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 880,
        "y": 2400,
        "wires": [
            []
        ]
    },
    {
        "id": "751ec40a6956d4f9",
        "type": "mqtt-broker",
        "name": "",
        "broker": "192.168.1.233",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    }
]