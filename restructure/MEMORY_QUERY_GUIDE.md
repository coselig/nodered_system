# è¨˜æ†¶æŸ¥è©¢åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ“‹ åŠŸèƒ½èªªæ˜

æ–°å¢äº†è¨˜æ†¶æŸ¥è©¢åŠŸèƒ½ï¼Œå¯ä»¥é€é Inject æŒ‰éˆ•æŸ¥çœ‹æ‰€æœ‰å·²å„²å­˜çš„å ´æ™¯è¨˜æ†¶ç‹€æ…‹ã€‚

## ğŸ¯ æŸ¥è©¢ Topic

**Topic**: `homeassistant/memory/query/all`

**Payload**: ä»»æ„å€¼ï¼ˆæˆ–ä¸è¨­å®šï¼‰

## ğŸ”§ è¨­å®š Inject ç¯€é»

### æ–¹å¼ä¸€ï¼šæ‰‹å‹•å»ºç«‹

1. **æ‹–æ›³ Inject ç¯€é»**åˆ° Flow ä¸­

2. **è¨­å®šç¯€é»å±¬æ€§**:
   - **Name**: `ğŸ” æŸ¥è©¢æ‰€æœ‰è¨˜æ†¶`
   - **msg.topic**: `homeassistant/memory/query/all`
   - **Repeat**: ä¸è¨­å®šï¼ˆæŒ‰éœ€æŸ¥è©¢ï¼‰

3. **é€£æ¥ç¯€é»**:
   ```
   Inject ç¯€é» â†’ å®Œæ•´è™•ç†å™¨ â†’ Debug ç¯€é»
   ```

4. **éƒ¨ç½²ä¸¦æ¸¬è©¦**

### æ–¹å¼äºŒï¼šåŒ¯å…¥ JSON

1. é–‹å•Ÿ `inject_memory_query.json`
2. ä¿®æ”¹ä»¥ä¸‹ ID:
   - `YOUR_FLOW_ID`: ä½ çš„ Flow ID
   - `YOUR_PROCESSOR_NODE_ID`: å®Œæ•´è™•ç†å™¨ç¯€é» ID
3. åœ¨ Node-RED ä¸­åŒ¯å…¥

## ğŸ“Š è¼¸å‡ºæ ¼å¼

### Debug è¼¸å‡ºç¯„ä¾‹

```javascript
{
    "payload": {
        "total_count": 3,
        "memories": [
            {
                "key": "memory_0x02_0x01",
                "display_name": "æœƒè­°å®¤_ON",
                "device_count": 5,
                "timestamp": "2025-11-25T14:30:00.123Z"
            },
            {
                "key": "memory_0x02_0x02",
                "display_name": "æœƒè­°å®¤_OFF",
                "device_count": 5,
                "timestamp": "2025-11-25T14:35:00.456Z"
            },
            {
                "key": "memory_0x03_0x01",
                "display_name": "å…¬å…±å€_ON",
                "device_count": 6,
                "timestamp": "2025-11-25T15:00:00.789Z"
            }
        ],
        "timestamp": "2025-11-25T15:30:00.000Z"
    },
    "allMemories": [
        {
            "key": "memory_0x02_0x01",
            "scene_id": "0x02",
            "operation": "0x01",
            "scene_name": "æœƒè­°å®¤_ON",
            "display_name": "æœƒè­°å®¤_ON",
            "device_count": 5,
            "timestamp": "2025-11-25T14:30:00.123Z",
            "devices": {
                "homeassistant/light/single/13/1": {
                    "state": "ON",
                    "brightness": 80,
                    "colortemp": undefined
                },
                "homeassistant/light/dual/14/a": {
                    "state": "ON",
                    "brightness": 60,
                    "colortemp": 250
                }
                // ... å…¶ä»–è¨­å‚™
            }
        }
        // ... å…¶ä»–è¨˜æ†¶
    ]
}
```

### è¼¸å‡ºæ¬„ä½èªªæ˜

**payload** (æ‘˜è¦è³‡è¨Š):
- `total_count`: ç¸½å…±æ‰¾åˆ°çš„è¨˜æ†¶æ•¸é‡
- `memories[]`: è¨˜æ†¶æ¸…å–®ï¼ˆç°¡è¦ï¼‰
  - `key`: è¨˜æ†¶çš„ Cache Key
  - `display_name`: é¡¯ç¤ºåç¨±ï¼ˆå ´æ™¯_æ“ä½œï¼‰
  - `device_count`: åŒ…å«çš„è¨­å‚™æ•¸é‡
  - `timestamp`: å„²å­˜æ™‚é–“
- `timestamp`: æŸ¥è©¢æ™‚é–“

**allMemories** (å®Œæ•´è³‡è¨Š):
- åŒ…å«æ‰€æœ‰è¨˜æ†¶çš„å®Œæ•´è¨­å‚™ç‹€æ…‹
- `devices`: æ¯å€‹è¨­å‚™çš„è©³ç´°ç‹€æ…‹ï¼ˆstate, brightness, colortempï¼‰

## ğŸ” Debug è¨Šæ¯

å•Ÿç”¨ cache debug æŸ¥çœ‹è©³ç´°è¼¸å‡ºï¼š

```javascript
global.set('debug_config', { cache: true });
```

### Debug è¼¸å‡ºç¯„ä¾‹

```
=== æŸ¥è©¢æ‰€æœ‰è¨˜æ†¶ç‹€æ…‹ ===
âœ… memory_0x02_0x01: æœƒè­°å®¤_ON (5å€‹è¨­å‚™) - 2025-11-25T14:30:00.123Z
âœ… memory_0x02_0x02: æœƒè­°å®¤_OFF (5å€‹è¨­å‚™) - 2025-11-25T14:35:00.456Z
âœ… memory_0x03_0x01: å…¬å…±å€_ON (6å€‹è¨­å‚™) - 2025-11-25T15:00:00.789Z
ğŸ“Š ç¸½å…±æ‰¾åˆ° 3 çµ„è¨˜æ†¶
```

å¦‚æœæ²’æœ‰è¨˜æ†¶ï¼š
```
=== æŸ¥è©¢æ‰€æœ‰è¨˜æ†¶ç‹€æ…‹ ===
âš ï¸ æ²’æœ‰æ‰¾åˆ°ä»»ä½•è¨˜æ†¶
```

## ğŸ“‹ æŸ¥è©¢çš„å ´æ™¯åˆ—è¡¨

ç³»çµ±æœƒæª¢æŸ¥ä»¥ä¸‹æ‰€æœ‰è¨˜æ†¶çµ„åˆï¼š

| Scene ID | å ´æ™¯åç¨± | æ“ä½œ | Cache Key |
|----------|---------|------|-----------|
| 0x02 | æœƒè­°å®¤ | ON (0x01) | `memory_0x02_0x01` |
| 0x02 | æœƒè­°å®¤ | OFF (0x02) | `memory_0x02_0x02` |
| 0x03 | å…¬å…±å€ | ON (0x01) | `memory_0x03_0x01` |
| 0x03 | å…¬å…±å€ | OFF (0x02) | `memory_0x03_0x02` |
| 0x04 | æˆ¶å¤– | ON (0x01) | `memory_0x04_0x01` |
| 0x04 | æˆ¶å¤– | OFF (0x02) | `memory_0x04_0x02` |
| 0x05 | H40äºŒæ¨“ | ON (0x01) | `memory_0x05_0x01` |
| 0x05 | H40äºŒæ¨“ | OFF (0x02) | `memory_0x05_0x02` |

ç¸½å…±æœ€å¤š **8 çµ„**è¨˜æ†¶ã€‚

## ğŸ¨ Node ç‹€æ…‹é¡¯ç¤º

æŸ¥è©¢åŸ·è¡Œæ™‚ï¼Œå®Œæ•´è™•ç†å™¨ç¯€é»æœƒé¡¯ç¤ºï¼š

```
ğŸ”µ è¨˜æ†¶æŸ¥è©¢: 3 çµ„
```

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

### 1. å…ˆå„²å­˜ä¸€äº›è¨˜æ†¶

```bash
# å„²å­˜æœƒè­°å®¤ ON ç‹€æ…‹
Topic: homeassistant/memory/0x02/0x01/save/set
Payload: {"scene_name": "æœƒè­°å®¤_ON", "devices": [...], "timestamp": "..."}

# å„²å­˜å…¬å…±å€ OFF ç‹€æ…‹
Topic: homeassistant/memory/0x03/0x02/save/set
Payload: {"scene_name": "å…¬å…±å€_OFF", "devices": [...], "timestamp": "..."}
```

### 2. æŸ¥è©¢æ‰€æœ‰è¨˜æ†¶

é»æ“Š `ğŸ” æŸ¥è©¢æ‰€æœ‰è¨˜æ†¶` Inject æŒ‰éˆ•

### 3. æŸ¥çœ‹ Debug è¼¸å‡º

åœ¨ Debug é¢æ¿ä¸­æª¢è¦–ï¼š
- ç¸½è¨˜æ†¶æ•¸é‡
- æ¯å€‹è¨˜æ†¶çš„æ‘˜è¦
- å®Œæ•´çš„è¨­å‚™ç‹€æ…‹ï¼ˆå±•é–‹ `allMemories`ï¼‰

## ğŸ’¡ ä½¿ç”¨å ´æ™¯

1. **ç³»çµ±ç¶­è­·**: æª¢æŸ¥å“ªäº›è¨˜æ†¶å·²å„²å­˜
2. **é™¤éŒ¯**: ç¢ºèªè¨˜æ†¶å…§å®¹æ˜¯å¦æ­£ç¢º
3. **ç›£æ§**: å®šæœŸæŸ¥è©¢è¨˜æ†¶ç‹€æ…‹
4. **åŒ¯å‡º**: å–å¾—å®Œæ•´è¨˜æ†¶è³‡æ–™ä¾›å‚™ä»½

## ğŸ”§ é€²éšæ‡‰ç”¨

### å®šæ™‚æŸ¥è©¢

è¨­å®š Inject ç¯€é»çš„ `Repeat` å±¬æ€§ï¼š
- æ¯å°æ™‚æŸ¥è©¢ä¸€æ¬¡
- æ¯å¤©æ—©ä¸Š 9:00 æŸ¥è©¢

### è‡ªå‹•åŒ¯å‡º

æ·»åŠ  File Out ç¯€é»ï¼š
```
Inject â†’ å®Œæ•´è™•ç†å™¨ â†’ Function (æ ¼å¼åŒ–) â†’ File Out
```

æ ¼å¼åŒ–å‡½æ•¸ç¯„ä¾‹ï¼š
```javascript
const data = msg.allMemories;
const json = JSON.stringify(data, null, 2);
msg.payload = json;
msg.filename = `memory_backup_${new Date().toISOString()}.json`;
return msg;
```

### Dashboard é¡¯ç¤º

ä½¿ç”¨ UI Template ç¯€é»é¡¯ç¤ºè¨˜æ†¶åˆ—è¡¨ï¼š
```html
<ul>
    <li ng-repeat="m in msg.payload.memories">
        {{m.display_name}} - {{m.device_count}}å€‹è¨­å‚™ ({{m.timestamp}})
    </li>
</ul>
```

## ğŸ“Œ æ³¨æ„äº‹é …

1. **åªæŸ¥è©¢å·²å­˜åœ¨çš„è¨˜æ†¶**: ä¸æœƒé¡¯ç¤ºæœªå„²å­˜çš„å ´æ™¯
2. **å³æ™‚ç‹€æ…‹**: é¡¯ç¤ºç•¶å‰ Flow Cache ä¸­çš„è¨˜æ†¶
3. **é‡å•Ÿå¾Œæ¶ˆå¤±**: è¨˜æ†¶å­˜åœ¨ Flow Contextï¼Œé‡å•Ÿ Node-RED æœƒæ¸…ç©º
4. **å®Œæ•´è³‡æ–™**: `allMemories` åŒ…å«æ‰€æœ‰è¨­å‚™çš„è©³ç´°ç‹€æ…‹ï¼Œè³‡æ–™é‡è¼ƒå¤§

## ğŸ‰ å®Œæˆï¼

ç¾åœ¨ä½ å¯ä»¥éš¨æ™‚æŸ¥è©¢æ‰€æœ‰å ´æ™¯è¨˜æ†¶çš„ç‹€æ…‹äº†ï¼

**å¿«é€Ÿæ¸¬è©¦**:
1. é»æ“Š Inject æŒ‰éˆ•
2. æŸ¥çœ‹ Debug è¼¸å‡º
3. ç¢ºèªè¨˜æ†¶è³‡æ–™æ­£ç¢º

éœ€è¦å…¶ä»–åŠŸèƒ½ï¼ˆå¦‚åˆªé™¤è¨˜æ†¶ã€åŒ¯å‡º/åŒ¯å…¥è¨˜æ†¶ï¼‰è«‹éš¨æ™‚æå‡ºï¼
