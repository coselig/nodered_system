# æª”æ¡ˆçµæ§‹èªªæ˜

```
restructure/
â”‚
â”œâ”€â”€ ğŸ“„ è™•ç†å™¨å‡½æ•¸ (JavaScript)
â”‚   â”œâ”€â”€ full_processor.js          # å®Œæ•´è™•ç†å™¨é‚è¼¯ (15KB)
â”‚   â”œâ”€â”€ feedback_processor.js      # å›æ‡‰è™•ç†å™¨é‚è¼¯ (11KB)
â”‚   â””â”€â”€ hmi_processor.js           # HMI è™•ç†å™¨é‚è¼¯ (13KB)
â”‚
â”œâ”€â”€ ğŸ“‹ Node-RED ç¯€é»å®šç¾© (JSON)
â”‚   â”œâ”€â”€ full_processor.json        # å®Œæ•´è™•ç†å™¨ç¯€é»
â”‚   â”œâ”€â”€ feedback_processor.json    # å›æ‡‰è™•ç†å™¨ç¯€é»
â”‚   â”œâ”€â”€ hmi_processor.json         # HMI è™•ç†å™¨ç¯€é»
â”‚   â”œâ”€â”€ node_configs.json          # å…¶ä»–é…ç½®ç¯€é»ï¼ˆMQTT, TCP, Debug ç­‰ï¼‰
â”‚   â””â”€â”€ all_nodes.json             # å®Œæ•´ Flowï¼ˆæ‰€æœ‰ç¯€é»ï¼‰
â”‚
â”œâ”€â”€ ğŸ› ï¸ å·¥å…·è…³æœ¬
â”‚   â””â”€â”€ sync_js_to_json.py         # åŒæ­¥å·¥å…·ï¼šJS â†’ JSON
â”‚
â”œâ”€â”€ ğŸ“– æ–‡ä»¶
â”‚   â”œâ”€â”€ README.md                  # å®Œæ•´èªªæ˜æ–‡ä»¶
â”‚   â””â”€â”€ STRUCTURE.md               # æœ¬æª”æ¡ˆ
â”‚
â””â”€â”€ ğŸ”„ å·¥ä½œæµç¨‹
    1. ç·¨è¼¯ .js æª”æ¡ˆï¼ˆä¿®æ”¹é‚è¼¯ï¼‰
    2. åŸ·è¡Œ sync_js_to_json.pyï¼ˆåŒæ­¥åˆ° JSONï¼‰
    3. åŒ¯å…¥ Node-RED æ¸¬è©¦
    4. å®Œæˆï¼
```

## ç¯€é»é—œä¿‚åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MQTT In       â”‚  è¨‚é–± HA æ§åˆ¶æŒ‡ä»¤
â”‚  (port 1883)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Full Processor  â”‚  è§£æä¸¦è½‰æ›æŒ‡ä»¤
â”‚  (function)     â”‚  â†’ Modbus æŒ‡ä»¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                  â”‚
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TCP Request    â”‚  â”‚  MQTT Out       â”‚
â”‚  â†’ Modbus TCP   â”‚  â”‚  â†’ HA ç‹€æ…‹      â”‚
â”‚  (port 502)     â”‚  â”‚  (port 1883)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feedback        â”‚  è§£æ Modbus å›æ‡‰
â”‚  Processor      â”‚  â†’ æ›´æ–°ç‹€æ…‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MQTT Out      â”‚  ç™¼å¸ƒç‹€æ…‹æ›´æ–°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HMI TCP In     â”‚  è§¸æ§è¢å¹•è¼¸å…¥
â”‚  (port 8888)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HMI Processor   â”‚  è§£æ HMI æŒ‡ä»¤
â”‚  (function)     â”‚  â†’ MQTT æŒ‡ä»¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MQTT Out      â”‚  ç™¼é€æ§åˆ¶æŒ‡ä»¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è™•ç†å™¨è©³ç´°è³‡è¨Š

### full_processor.js

**è¼¸å…¥æ ¼å¼**:
```
homeassistant/light/single/12/1/set          â†’ ON/OFF
homeassistant/light/single/12/1/set/brightness  â†’ 0-100
homeassistant/light/dual/14/a/set/colortemp     â†’ 167-333
homeassistant/cover/general/12/set              â†’ 1_2/3
homeassistant/query/dual/14/a                   â†’ æŸ¥è©¢
```

**è¼¸å‡º**:
- Output 1: Modbus æŒ‡ä»¤ (Buffer)
- Output 2: MQTT ç‹€æ…‹è¨Šæ¯

**å¿«å– Keys**:
```javascript
// ç‹€æ…‹
single_12_1_state = "ON"/"OFF"
dual_14_a_state = "ON"/"OFF"

// å±¬æ€§
single_12_1_brightness = 0-100
dual_14_a_brightness = 0-100
dual_14_a_colortemp = 167-333

// å ´æ™¯
scene_single_12-1--12-2_brightness = 0-100
scene_dual_14-a--14-b_colortemp = 167-333
```

### feedback_processor.js

**è¼¸å…¥æ ¼å¼**: Modbus TCP Response (Buffer)

**è™•ç†æµç¨‹**:
1. è§£æ Function Code (0x05/0x06/0x03/0x01)
2. æå–å¯„å­˜å™¨åœ°å€å’Œæ•¸å€¼
3. æ˜ å°„åˆ°è¨­å‚™é¡å‹å’Œé€šé“
4. æ›´æ–°å¿«å–
5. ç™¼å¸ƒ MQTT ç‹€æ…‹

**è¼¸å‡º**: MQTT ç‹€æ…‹è¨Šæ¯

### hmi_processor.js

**è¼¸å…¥æ ¼å¼**: HMI Binary Commands (Buffer)

**Pattern åŒ¹é…**:
```javascript
// çª—ç°¾
[moduleId, 0x06, 0x01, 0x9b, 0x00, action, ...]

// å ´æ™¯
[0xfe, 0x06, 0x08, 0x20, operation, sceneId, ...]

// ç‡ˆå…‰
[0xEE, 0xB1, 0x11, 0x00, sceneId, 0x00, functionId, ...]

// HVAC
[0x01, 0x31-0x34, value, 0x01, 0x01, hvacId]
```

**è¼¸å‡º**: MQTT æ§åˆ¶æŒ‡ä»¤

## ä¿®æ”¹æŒ‡å—

### ä¿®æ”¹è™•ç†å™¨é‚è¼¯

1. **ç·¨è¼¯ JS æª”æ¡ˆ**
   ```bash
   # ä½¿ç”¨ä»»ä½•ç·¨è¼¯å™¨é–‹å•Ÿ
   notepad full_processor.js
   ```

2. **åŒæ­¥åˆ° JSON**
   ```bash
   python sync_js_to_json.py
   ```

3. **åŒ¯å…¥ Node-RED**
   - æ–¹å¼ 1: åŒ¯å…¥ `full_processor.json` (å–®ä¸€ç¯€é»)
   - æ–¹å¼ 2: åŒ¯å…¥ `test_full_integrated_rebuilt.json` (å®Œæ•´ Flow)

### æ–°å¢è¨­å‚™é¡å‹

åœ¨ `full_processor.js` ä¸­æ–°å¢ï¼š

```javascript
// åœ¨ LIGHT DEVICE å€å¡Šå¾Œæ–°å¢
else if (deviceType === "fan") {
    // é¢¨æ‰‡æ§åˆ¶é‚è¼¯
    const speed = parseInt(msg.payload);  // 0-3
    // ... Modbus æŒ‡ä»¤ç”Ÿæˆ
}
```

åŒæ­¥å¾ŒåŒ¯å…¥ Node-RED å³å¯ã€‚

## ç‰ˆæœ¬æ§åˆ¶

å»ºè­°ä½¿ç”¨ Git è¿½è¹¤æ‰€æœ‰æª”æ¡ˆï¼š

```bash
git add restructure/
git commit -m "é‡æ§‹: æ‹†è§£ test_full_integrated æˆæ¨¡çµ„åŒ–çµæ§‹"
```

### é‡è¦æª”æ¡ˆå„ªå…ˆç´š

**å¿…é ˆè¿½è¹¤**:
- âœ… `*.js` (é‚è¼¯ç¨‹å¼ç¢¼)
- âœ… `sync_js_to_json.py` (åŒæ­¥å·¥å…·)
- âœ… `README.md`, `STRUCTURE.md` (æ–‡ä»¶)

**é¸æ“‡æ€§è¿½è¹¤**:
- ğŸ”„ `*.json` (å¯å¾ .js é‡å»º)
- ğŸ”„ `all_nodes.json` (å‚™ä»½ç”¨)

## å‚™ä»½ç­–ç•¥

1. **æ¯æ¬¡ä¿®æ”¹å‰å‚™ä»½**
   ```bash
   cp full_processor.js full_processor.js.bak
   ```

2. **å®šæœŸé‡å»ºå®Œæ•´ JSON**
   ```bash
   python sync_js_to_json.py
   ```

3. **æ¸¬è©¦å¾Œä¿å­˜ç©©å®šç‰ˆæœ¬**
   ```bash
   git tag v1.0-stable
   ```
