{
    "id": "hmi_processor",
    "type": "function",
    "z": "14580213f897af9a",
    "g": "108057c6b0820334",
    "name": "HMI 處理器",
    "func": "const MIN_MIRED = 167, MAX_MIRED = 333;\n\n// Debug 控制\nconst debugConfig = global.get('debug_config') || {\n    topic: true,\n    cache: true,\n    modbus: true,\n    mqtt: true,\n    scene: true,\n    query: true,\n    hmi: true\n};\n\nfunction debugLog(category, message) {\n    if (debugConfig[category]) {\n        node.warn(message);\n    }\n}\n\nconst HMI_pattern = [\n    // 窗簾控制\n    {\n        name: \"curtain_control\",\n        pattern: [null, 0x06, 0x01, 0x9b, 0x00, null, null, null],\n        parse: (input) => {\n            const curtainId = input[0];\n            const action = input[5];\n\n            const CURTAIN_MAP = {\n                0x15: { topic: \"homeassistant/cover/curtain/21/ocs/set\", type: \"ocs\" },\n                0x16: { topic: \"homeassistant/cover/curtain/22/oc/set\", type: \"oc\" },\n                0x17: { topic: \"homeassistant/cover/curtain/23\", type: \"multi\" }\n            };\n\n            const config = CURTAIN_MAP[curtainId];\n            if (!config) return null;\n\n            let payload, topicSuffix;\n\n            if (config.type === \"ocs\") {\n                const ACTION_MAP_OCS = {\n                    0x01: \"1/2-3\",\n                    0x04: \"2/1-3\",\n                    0x02: \"3/1-2\"\n                };\n                payload = ACTION_MAP_OCS[action];\n                topicSuffix = \"/set\";\n            } else if (config.type === \"oc\") {\n                const ACTION_MAP_OC = {\n                    0x01: \"1/2\",\n                    0x02: \"2/1\",\n                    0x03: \"1-2/\"\n                };\n                payload = ACTION_MAP_OC[action];\n                topicSuffix = \"/set\";\n            } else if (config.type === \"multi\") {\n                const ACTION_MAP_MULTI = {\n                    0x01: { suffix: \"/oc/set\", payload: \"1/2\" },\n                    0x03: { suffix: \"/oc/set\", payload: \"1_2/\" },\n                    0x02: { suffix: \"/oc/set\", payload: \"2/1\" },\n                    0x04: { suffix: \"/oc/set\", payload: \"3/4\" },\n                    0x0C: { suffix: \"/oc/set\", payload: \"3_4/\" },\n                    0x08: { suffix: \"/oc/set\", payload: \"4/3\" },\n                    0x10: { suffix: \"/ocs/set\", payload: \"5/6_7\" },\n                    0x40: { suffix: \"/ocs/set\", payload: \"7/5_6\" },\n                    0x20: { suffix: \"/ocs/set\", payload: \"6/5_7\" }\n                };\n                const actionConfig = ACTION_MAP_MULTI[action];\n                if (!actionConfig) return null;\n                topicSuffix = actionConfig.suffix;\n                payload = actionConfig.payload;\n            }\n\n            if (!payload) return null;\n            return [{ topic: config.topic + topicSuffix, payload: payload }];\n        }\n    },\n    // 場景控制\n    {\n        name: \"scene_unified\",\n        pattern: [0xfe, 0x06, 0x08, 0x20, null, null, null, null],\n        parse: (input) => {\n            const operation = input[4];\n            const sceneId = input[5];\n\n            // 記憶指令處理\n            if (operation >= 0x81 && operation <= 0x88) {\n                const MEMORY_TO_TEST_MAP = {\n                    0x81: { sceneId: \"0x02\", operation: \"0x01\" },\n                    0x82: { sceneId: \"0x02\", operation: \"0x02\" },\n                    0x83: { sceneId: \"0x03\", operation: \"0x01\" },\n                    0x84: { sceneId: \"0x03\", operation: \"0x02\" },\n                    0x85: { sceneId: \"0x04\", operation: \"0x01\" },\n                    0x86: { sceneId: \"0x04\", operation: \"0x02\" },\n                    0x87: { sceneId: \"0x05\", operation: \"0x01\" },\n                    0x88: { sceneId: \"0x05\", operation: \"0x02\" }\n                };\n\n                const SCENE_MEMORY_MAP = {\n                    \"0x02\": {\n                        name: \"會議室\", devices: [\n                            \"homeassistant/light/single/13/1\",\n                            \"homeassistant/light/single/13/2\",\n                            \"homeassistant/light/single/13/3\",\n                            \"homeassistant/light/dual/14/a\",\n                            \"homeassistant/light/dual/14/b\"\n                        ]\n                    },\n                    \"0x03\": {\n                        name: \"公共區\", devices: [\n                            \"homeassistant/light/single/11/1\",\n                            \"homeassistant/light/single/11/2\",\n                            \"homeassistant/light/single/12/1\",\n                            \"homeassistant/light/single/12/2\",\n                            \"homeassistant/light/single/12/3\",\n                            \"homeassistant/light/single/12/4\"\n                        ]\n                    },\n                    \"0x04\": {\n                        name: \"戶外\", devices: [\n                            \"homeassistant/light/single/18/1\",\n                            \"homeassistant/light/single/18/2\",\n                            \"homeassistant/light/single/19/1\",\n                            \"homeassistant/light/single/19/2\"\n                        ]\n                    },\n                    \"0x05\": {\n                        name: \"H40二樓\", devices: [\n                            \"homeassistant/light/single/15/1\",\n                            \"homeassistant/light/single/15/2\",\n                            \"homeassistant/light/single/16/1\",\n                            \"homeassistant/light/single/16/2\",\n                            \"homeassistant/light/single/17/1\",\n                            \"homeassistant/light/single/17/2\",\n                            \"homeassistant/light/single/18/1\",\n                            \"homeassistant/light/single/18/2\",\n                            \"homeassistant/light/single/19/1\",\n                            \"homeassistant/light/single/19/2\"\n                        ]\n                    }\n                };\n\n                const mapping = MEMORY_TO_TEST_MAP[operation];\n                if (!mapping) return null;\n\n                const targetSceneId = mapping.sceneId;\n                const targetOperation = mapping.operation;\n                const sceneInfo = SCENE_MEMORY_MAP[targetSceneId];\n                if (!sceneInfo) return null;\n\n                const opNames = { \"0x01\": \"ON\", \"0x02\": \"OFF\" };\n                const opName = opNames[targetOperation] || targetOperation;\n                const memoryTopic = `homeassistant/memory/${targetSceneId}/${targetOperation}/save/set`;\n                const buttonNum = operation - 0x80;\n\n                debugLog('hmi', `HMI記憶按鈕${buttonNum} → ${sceneInfo.name}_${opName}`);\n\n                return [{\n                    topic: memoryTopic,\n                    payload: JSON.stringify({\n                        scene_name: `${sceneInfo.name}_${opName}`,\n                        devices: sceneInfo.devices,\n                        timestamp: new Date().toISOString()\n                    })\n                }];\n            }\n\n            // 測試按鈕處理\n            const testSceneIds = [0x02, 0x03, 0x04, 0x05];\n            if ((operation === 0x01 || operation === 0x02) && testSceneIds.includes(sceneId)) {\n                const sceneKey = `0x${sceneId.toString(16).padStart(2, '0').toUpperCase()}`;\n                const opKey = `0x${operation.toString(16).padStart(2, '0').toUpperCase()}`;\n                debugLog('hmi', `HMI測試按鈕: 場景${sceneKey} 操作${opKey}`);\n                return [{\n                    topic: `homeassistant/scene/${sceneKey}/${opKey}/execute/set`,\n                    payload: \"ON\"\n                }];\n            }\n\n            // 一般場景控制\n            const sceneKey = `0x${sceneId.toString(16).toUpperCase()}`;\n            const opKey = `0x${operation.toString(16).padStart(2, '0').toUpperCase()}`;\n            return [{\n                topic: `homeassistant/scene/${sceneKey}/${opKey}/execute/set`,\n                payload: \"ON\"\n            }];\n        }\n    },\n    // 燈光控制\n    {\n        name: \"light_control_unified\",\n        pattern: [0xEE, 0xB1, 0x11, 0x00, null, 0x00, null, 0x13, 0x00, 0x00, null, null, 0xFF, 0xFC, 0xFF, 0xFF],\n        parse: (input) => {\n            const sceneId = input[4];\n            const functionId = input[6];\n            const valueHigh = input[10];\n            const valueLow = input[11];\n            const raw = (valueHigh << 8) + valueLow;\n\n            let value = Math.round((raw / 1000) * 100);\n            value = value < 0 ? 0 : value > 100 ? 100 : value;\n            let state = value > 0 ? \"ON\" : \"OFF\";\n\n            const LIGHT_MAP = {\n                \"0x1E-0x0B\": { topic: \"homeassistant/light/scene/single/11-1--11-2\", type: \"brightness\" },\n                \"0x1E-0x0D\": { topic: \"homeassistant/light/scene/single/12-1\", type: \"brightness\" },\n                \"0x1E-0x0F\": { topic: \"homeassistant/light/scene/single/12-2\", type: \"brightness\" },\n                \"0x1E-0x11\": { topic: \"homeassistant/light/scene/single/12-3--12-4\", type: \"brightness\" },\n                \"0x1F-0x0B\": { topic: \"homeassistant/light/dual/14/a\", type: \"brightness\" },\n                \"0x1F-0x0D\": { topic: \"homeassistant/light/dual/14/a\", type: \"colortemp\" },\n                \"0x1F-0x0F\": { topic: \"homeassistant/light/dual/14/b\", type: \"brightness\" },\n                \"0x1F-0x11\": { topic: \"homeassistant/light/dual/14/b\", type: \"colortemp\" }\n            };\n\n            const key = `0x${sceneId.toString(16).toUpperCase()}-0x${functionId.toString(16).toUpperCase()}`;\n            const config = LIGHT_MAP[key];\n            if (!config) return null;\n\n            const baseTopic = config.topic;\n\n            if (config.type === \"brightness\") {\n                debugLog('hmi', `HMI燈光控制: ${baseTopic} 亮度=${value}%`);\n                return [\n                    { topic: `${baseTopic}/set/brightness`, payload: value }\n                ];\n            } else if (config.type === \"colortemp\") {\n                const colortemp = Math.round(MAX_MIRED - ((MAX_MIRED - MIN_MIRED) * value / 100));\n                debugLog('hmi', `HMI燈光控制: ${baseTopic} 色溫=${colortemp} mired`);\n                return [\n                    { topic: `${baseTopic}/set/colortemp`, payload: colortemp }\n                ];\n            }\n            return null;\n        }\n    },\n    // 空調控制\n    {\n        name: \"hvac_power_mode\",\n        pattern: [0x01, 0x31, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const powerValue = input[2];\n            const hvacId = input[5];\n            const mode = powerValue === 0x01 ? \"auto\" : \"off\";\n            debugLog('hmi', `HMI空調: ${hvacId} 模式=${mode}`);\n            return [{ topic: `homeassistant/hvac/200/${hvacId}/mode/set`, payload: mode }];\n        }\n    },\n    {\n        name: \"hvac_temperature\",\n        pattern: [0x01, 0x32, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const tempValue = input[2];\n            const hvacId = input[5];\n            debugLog('hmi', `HMI空調: ${hvacId} 溫度=${tempValue}°C`);\n            return [{ topic: `homeassistant/hvac/200/${hvacId}/temperature/set`, payload: String(tempValue) }];\n        }\n    },\n    {\n        name: \"hvac_mode\",\n        pattern: [0x01, 0x33, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const modeValue = input[2];\n            const hvacId = input[5];\n            const MODE_MAP = {\n                0x00: \"cool\",\n                0x01: \"dry\",\n                0x02: \"fan_only\",\n                0x04: \"heat\"\n            };\n            const mode = MODE_MAP[modeValue];\n            if (!mode) return null;\n            debugLog('hmi', `HMI空調: ${hvacId} 模式=${mode}`);\n            return [{ topic: `homeassistant/hvac/200/${hvacId}/mode/set`, payload: mode }];\n        }\n    },\n    {\n        name: \"hvac_fan_speed\",\n        pattern: [0x01, 0x34, null, 0x01, 0x01, null],\n        parse: (input) => {\n            const fanValue = input[2];\n            const hvacId = input[5];\n            const FAN_MAP = {\n                0x03: \"medium\",\n                0x04: \"high\",\n                0x07: \"low\"\n            };\n            const fan = FAN_MAP[fanValue];\n            if (!fan) return null;\n            const topicSuffix = hvacId === 1 ? \"fan/set\" : \"mode/fan\";\n            debugLog('hmi', `HMI空調: ${hvacId} 風量=${fan}`);\n            return [{ topic: `homeassistant/hvac/200/${hvacId}/${topicSuffix}`, payload: fan }];\n        }\n    }\n];\n\nfunction matchPattern(input, pattern) {\n    if (input.length !== pattern.length) return false;\n    for (let i = 0; i < pattern.length; i++) {\n        if (pattern[i] !== null && pattern[i] !== input[i]) {\n            return false;\n        }\n    }\n    return true;\n}\n\nfunction bufferToHexArray(buf) {\n    return [...buf].map(v => \"0x\" + v.toString(16).padStart(2, \"0\").toUpperCase());\n}\n\nif (!msg.payload || !Buffer.isBuffer(msg.payload)) {\n    debugLog('hmi', \"HMI收到無效的 payload\");\n    return null;\n}\n\nlet input = Array.from(msg.payload);\nlet result = null;\n\nfor (const p of HMI_pattern) {\n    if (matchPattern(input, p.pattern)) {\n        result = p.parse(input);\n        break;\n    }\n}\n\nif (result && Array.isArray(result) && result.length > 0) {\n    debugLog('hmi', `HMI收到: ${bufferToHexArray(msg.payload)} → ${result.length} 個 MQTT 指令`);\n    return [result];\n} else {\n    debugLog('hmi', `HMI收到: ${bufferToHexArray(msg.payload)} (未匹配)`);\n    return null;\n}",
    "outputs": 1,
    "timeout": 0,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 390,
    "y": 2180,
    "wires": [
        [
            "hmi_debug",
            "e67cfaa863dbcbf7"
        ]
    ]
}